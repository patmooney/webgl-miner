(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))r(a);new MutationObserver(a=>{for(const c of a)if(c.type==="childList")for(const l of c.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&r(l)}).observe(document,{childList:!0,subtree:!0});function e(a){const c={};return a.integrity&&(c.integrity=a.integrity),a.referrerPolicy&&(c.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?c.credentials="include":a.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function r(a){if(a.ep)return;a.ep=!0;const c=e(a);fetch(a.href,c)}})();const b=40,g=50,pt=30,ht=6,P=1/ht,j=3,Ee=10,yt=200,$e=1e3,Ge=600,ue={RIGHT:0,LEFT:2,DOWN:1},pe={0:0*Math.PI/180,1:90*Math.PI/180,2:180*Math.PI/180,3:270*Math.PI/180},Oe=360*Math.PI/180,Ce={FLOOR:0,ROCK:10,ORE:100,SHADOW:0,HOME:0},be={FLOOR:!0,ROCK:!1,ORE:!1,SHADOW:!1,HOME:!0},x={FLOOR:0,ROCK:1,SHADOW:3,HOME:4,ORE:5},vt={ROCK:[{item:"stone",chance:.5},{item:"iron",baseChance:.02}],ORE:[{item:"stone",chance:.01},{item:"iron",baseChance:.05},{item:"copper",baseChance:.02},{item:"carbon",baseChance:.01}]},Et=o=>Object.entries(x).find(([,n])=>n===o)?.[0]??"FLOOR",We=()=>{const o=g/2-4,n=g/2+4,e=g/2-2,r=g/2+2;let a=[];for(let c=0;c<g*g;c++){const l=c%g,p=Math.floor(c/g);if(p>e&&p<r&&l>e&&l<r){a.push(x.HOME,1,0);continue}if(p>o&&p<n&&l>o&&l<n){a.push(x.FLOOR,1,0);continue}if((p===o||p===n)&&l>=o&&l<=n){a.push(x.ROCK,1,1);continue}if((l===o||l===n)&&p>=o&&p<=n){a.push(x.ROCK,1,1);continue}a.push(x.SHADOW,1,1)}return new Float32Array(a)},C=o=>{const[n,e]=o,r=e*g+n,a=Z().at(r*j),c=Z().at(r*j+1)??0;if(a===void 0)throw new Error(`Invalid tile ${n} / ${e}`);return{coord:o,tile:Et(a),type:a,durability:c,tileN:r}},k=o=>[Math.round(o[0]/b),Math.round(o[1]/b)],bt=o=>{const n=[],[e,r]=o;return e>0&&n.push(C([e-1,r])),e<g-1&&n.push(C([e+1,r])),r>0&&n.push(C([e,r-1])),r<g-1&&n.push(C([e,r+1])),n},Tt=o=>{const n=g/2;return Math.round(Math.sqrt(Math.pow(o.coord[0]-n,2)+Math.pow(o.coord[1]-n,2)))};let te;const Z=()=>(te||(te=We()),te),At=()=>{te=void 0,Z()},Ye=o=>{const n=Z(),e=o.tileN;n[e*j]=o.type,n[e*j+1]=o.durability,n[e*j+2]=be[o.tile]?0:1};var q=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},fe={};var Le;function wt(){return Le||(Le=1,(function(o){(function(){var n=function(){this.init()};n.prototype={init:function(){var t=this||e;return t._counter=1e3,t._html5AudioPool=[],t.html5PoolSize=10,t._codecs={},t._howls=[],t._muted=!1,t._volume=1,t._canPlayEvent="canplaythrough",t._navigator=typeof window<"u"&&window.navigator?window.navigator:null,t.masterGain=null,t.noAudio=!1,t.usingWebAudio=!0,t.autoSuspend=!0,t.ctx=null,t.autoUnlock=!0,t._setup(),t},volume:function(t){var i=this||e;if(t=parseFloat(t),i.ctx||E(),typeof t<"u"&&t>=0&&t<=1){if(i._volume=t,i._muted)return i;i.usingWebAudio&&i.masterGain.gain.setValueAtTime(t,e.ctx.currentTime);for(var s=0;s<i._howls.length;s++)if(!i._howls[s]._webAudio)for(var d=i._howls[s]._getSoundIds(),_=0;_<d.length;_++){var m=i._howls[s]._soundById(d[_]);m&&m._node&&(m._node.volume=m._volume*t)}return i}return i._volume},mute:function(t){var i=this||e;i.ctx||E(),i._muted=t,i.usingWebAudio&&i.masterGain.gain.setValueAtTime(t?0:i._volume,e.ctx.currentTime);for(var s=0;s<i._howls.length;s++)if(!i._howls[s]._webAudio)for(var d=i._howls[s]._getSoundIds(),_=0;_<d.length;_++){var m=i._howls[s]._soundById(d[_]);m&&m._node&&(m._node.muted=t?!0:m._muted)}return i},stop:function(){for(var t=this||e,i=0;i<t._howls.length;i++)t._howls[i].stop();return t},unload:function(){for(var t=this||e,i=t._howls.length-1;i>=0;i--)t._howls[i].unload();return t.usingWebAudio&&t.ctx&&typeof t.ctx.close<"u"&&(t.ctx.close(),t.ctx=null,E()),t},codecs:function(t){return(this||e)._codecs[t.replace(/^x-/,"")]},_setup:function(){var t=this||e;if(t.state=t.ctx&&t.ctx.state||"suspended",t._autoSuspend(),!t.usingWebAudio)if(typeof Audio<"u")try{var i=new Audio;typeof i.oncanplaythrough>"u"&&(t._canPlayEvent="canplay")}catch{t.noAudio=!0}else t.noAudio=!0;try{var i=new Audio;i.muted&&(t.noAudio=!0)}catch{}return t.noAudio||t._setupCodecs(),t},_setupCodecs:function(){var t=this||e,i=null;try{i=typeof Audio<"u"?new Audio:null}catch{return t}if(!i||typeof i.canPlayType!="function")return t;var s=i.canPlayType("audio/mpeg;").replace(/^no$/,""),d=t._navigator?t._navigator.userAgent:"",_=d.match(/OPR\/(\d+)/g),m=_&&parseInt(_[0].split("/")[1],10)<33,f=d.indexOf("Safari")!==-1&&d.indexOf("Chrome")===-1,v=d.match(/Version\/(.*?) /),T=f&&v&&parseInt(v[1],10)<15;return t._codecs={mp3:!!(!m&&(s||i.canPlayType("audio/mp3;").replace(/^no$/,""))),mpeg:!!s,opus:!!i.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!i.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!i.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!(i.canPlayType('audio/wav; codecs="1"')||i.canPlayType("audio/wav")).replace(/^no$/,""),aac:!!i.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!i.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(i.canPlayType("audio/x-m4a;")||i.canPlayType("audio/m4a;")||i.canPlayType("audio/aac;")).replace(/^no$/,""),m4b:!!(i.canPlayType("audio/x-m4b;")||i.canPlayType("audio/m4b;")||i.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(i.canPlayType("audio/x-mp4;")||i.canPlayType("audio/mp4;")||i.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!(!T&&i.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),webm:!!(!T&&i.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),dolby:!!i.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(i.canPlayType("audio/x-flac;")||i.canPlayType("audio/flac;")).replace(/^no$/,"")},t},_unlockAudio:function(){var t=this||e;if(!(t._audioUnlocked||!t.ctx)){t._audioUnlocked=!1,t.autoUnlock=!1,!t._mobileUnloaded&&t.ctx.sampleRate!==44100&&(t._mobileUnloaded=!0,t.unload()),t._scratchBuffer=t.ctx.createBuffer(1,1,22050);var i=function(s){for(;t._html5AudioPool.length<t.html5PoolSize;)try{var d=new Audio;d._unlocked=!0,t._releaseHtml5Audio(d)}catch{t.noAudio=!0;break}for(var _=0;_<t._howls.length;_++)if(!t._howls[_]._webAudio)for(var m=t._howls[_]._getSoundIds(),f=0;f<m.length;f++){var v=t._howls[_]._soundById(m[f]);v&&v._node&&!v._node._unlocked&&(v._node._unlocked=!0,v._node.load())}t._autoResume();var T=t.ctx.createBufferSource();T.buffer=t._scratchBuffer,T.connect(t.ctx.destination),typeof T.start>"u"?T.noteOn(0):T.start(0),typeof t.ctx.resume=="function"&&t.ctx.resume(),T.onended=function(){T.disconnect(0),t._audioUnlocked=!0,document.removeEventListener("touchstart",i,!0),document.removeEventListener("touchend",i,!0),document.removeEventListener("click",i,!0),document.removeEventListener("keydown",i,!0);for(var S=0;S<t._howls.length;S++)t._howls[S]._emit("unlock")}};return document.addEventListener("touchstart",i,!0),document.addEventListener("touchend",i,!0),document.addEventListener("click",i,!0),document.addEventListener("keydown",i,!0),t}},_obtainHtml5Audio:function(){var t=this||e;if(t._html5AudioPool.length)return t._html5AudioPool.pop();var i=new Audio().play();return i&&typeof Promise<"u"&&(i instanceof Promise||typeof i.then=="function")&&i.catch(function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")}),new Audio},_releaseHtml5Audio:function(t){var i=this||e;return t._unlocked&&i._html5AudioPool.push(t),i},_autoSuspend:function(){var t=this;if(!(!t.autoSuspend||!t.ctx||typeof t.ctx.suspend>"u"||!e.usingWebAudio)){for(var i=0;i<t._howls.length;i++)if(t._howls[i]._webAudio){for(var s=0;s<t._howls[i]._sounds.length;s++)if(!t._howls[i]._sounds[s]._paused)return t}return t._suspendTimer&&clearTimeout(t._suspendTimer),t._suspendTimer=setTimeout(function(){if(t.autoSuspend){t._suspendTimer=null,t.state="suspending";var d=function(){t.state="suspended",t._resumeAfterSuspend&&(delete t._resumeAfterSuspend,t._autoResume())};t.ctx.suspend().then(d,d)}},3e4),t}},_autoResume:function(){var t=this;if(!(!t.ctx||typeof t.ctx.resume>"u"||!e.usingWebAudio))return t.state==="running"&&t.ctx.state!=="interrupted"&&t._suspendTimer?(clearTimeout(t._suspendTimer),t._suspendTimer=null):t.state==="suspended"||t.state==="running"&&t.ctx.state==="interrupted"?(t.ctx.resume().then(function(){t.state="running";for(var i=0;i<t._howls.length;i++)t._howls[i]._emit("resume")}),t._suspendTimer&&(clearTimeout(t._suspendTimer),t._suspendTimer=null)):t.state==="suspending"&&(t._resumeAfterSuspend=!0),t}};var e=new n,r=function(t){var i=this;if(!t.src||t.src.length===0){console.error("An array of source files must be passed with any new Howl.");return}i.init(t)};r.prototype={init:function(t){var i=this;return e.ctx||E(),i._autoplay=t.autoplay||!1,i._format=typeof t.format!="string"?t.format:[t.format],i._html5=t.html5||!1,i._muted=t.mute||!1,i._loop=t.loop||!1,i._pool=t.pool||5,i._preload=typeof t.preload=="boolean"||t.preload==="metadata"?t.preload:!0,i._rate=t.rate||1,i._sprite=t.sprite||{},i._src=typeof t.src!="string"?t.src:[t.src],i._volume=t.volume!==void 0?t.volume:1,i._xhr={method:t.xhr&&t.xhr.method?t.xhr.method:"GET",headers:t.xhr&&t.xhr.headers?t.xhr.headers:null,withCredentials:t.xhr&&t.xhr.withCredentials?t.xhr.withCredentials:!1},i._duration=0,i._state="unloaded",i._sounds=[],i._endTimers={},i._queue=[],i._playLock=!1,i._onend=t.onend?[{fn:t.onend}]:[],i._onfade=t.onfade?[{fn:t.onfade}]:[],i._onload=t.onload?[{fn:t.onload}]:[],i._onloaderror=t.onloaderror?[{fn:t.onloaderror}]:[],i._onplayerror=t.onplayerror?[{fn:t.onplayerror}]:[],i._onpause=t.onpause?[{fn:t.onpause}]:[],i._onplay=t.onplay?[{fn:t.onplay}]:[],i._onstop=t.onstop?[{fn:t.onstop}]:[],i._onmute=t.onmute?[{fn:t.onmute}]:[],i._onvolume=t.onvolume?[{fn:t.onvolume}]:[],i._onrate=t.onrate?[{fn:t.onrate}]:[],i._onseek=t.onseek?[{fn:t.onseek}]:[],i._onunlock=t.onunlock?[{fn:t.onunlock}]:[],i._onresume=[],i._webAudio=e.usingWebAudio&&!i._html5,typeof e.ctx<"u"&&e.ctx&&e.autoUnlock&&e._unlockAudio(),e._howls.push(i),i._autoplay&&i._queue.push({event:"play",action:function(){i.play()}}),i._preload&&i._preload!=="none"&&i.load(),i},load:function(){var t=this,i=null;if(e.noAudio){t._emit("loaderror",null,"No audio support.");return}typeof t._src=="string"&&(t._src=[t._src]);for(var s=0;s<t._src.length;s++){var d,_;if(t._format&&t._format[s])d=t._format[s];else{if(_=t._src[s],typeof _!="string"){t._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}d=/^data:audio\/([^;,]+);/i.exec(_),d||(d=/\.([^.]+)$/.exec(_.split("?",1)[0])),d&&(d=d[1].toLowerCase())}if(d||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),d&&e.codecs(d)){i=t._src[s];break}}if(!i){t._emit("loaderror",null,"No codec support for selected audio sources.");return}return t._src=i,t._state="loading",window.location.protocol==="https:"&&i.slice(0,5)==="http:"&&(t._html5=!0,t._webAudio=!1),new a(t),t._webAudio&&l(t),t},play:function(t,i){var s=this,d=null;if(typeof t=="number")d=t,t=null;else{if(typeof t=="string"&&s._state==="loaded"&&!s._sprite[t])return null;if(typeof t>"u"&&(t="__default",!s._playLock)){for(var _=0,m=0;m<s._sounds.length;m++)s._sounds[m]._paused&&!s._sounds[m]._ended&&(_++,d=s._sounds[m]._id);_===1?t=null:d=null}}var f=d?s._soundById(d):s._inactiveSound();if(!f)return null;if(d&&!t&&(t=f._sprite||"__default"),s._state!=="loaded"){f._sprite=t,f._ended=!1;var v=f._id;return s._queue.push({event:"play",action:function(){s.play(v)}}),v}if(d&&!f._paused)return i||s._loadQueue("play"),f._id;s._webAudio&&e._autoResume();var T=Math.max(0,f._seek>0?f._seek:s._sprite[t][0]/1e3),S=Math.max(0,(s._sprite[t][0]+s._sprite[t][1])/1e3-T),M=S*1e3/Math.abs(f._rate),V=s._sprite[t][0]/1e3,Q=(s._sprite[t][0]+s._sprite[t][1])/1e3;f._sprite=t,f._ended=!1;var de=function(){f._paused=!1,f._seek=T,f._start=V,f._stop=Q,f._loop=!!(f._loop||s._sprite[t][2])};if(T>=Q){s._ended(f);return}var w=f._node;if(s._webAudio){var xe=function(){s._playLock=!1,de(),s._refreshBuffer(f);var $=f._muted||s._muted?0:f._volume;w.gain.setValueAtTime($,e.ctx.currentTime),f._playStart=e.ctx.currentTime,typeof w.bufferSource.start>"u"?f._loop?w.bufferSource.noteGrainOn(0,T,86400):w.bufferSource.noteGrainOn(0,T,S):f._loop?w.bufferSource.start(0,T,86400):w.bufferSource.start(0,T,S),M!==1/0&&(s._endTimers[f._id]=setTimeout(s._ended.bind(s,f),M)),i||setTimeout(function(){s._emit("play",f._id),s._loadQueue()},0)};e.state==="running"&&e.ctx.state!=="interrupted"?xe():(s._playLock=!0,s.once("resume",xe),s._clearTimer(f._id))}else{var Ie=function(){w.currentTime=T,w.muted=f._muted||s._muted||e._muted||w.muted,w.volume=f._volume*e.volume(),w.playbackRate=f._rate;try{var $=w.play();if($&&typeof Promise<"u"&&($ instanceof Promise||typeof $.then=="function")?(s._playLock=!0,de(),$.then(function(){s._playLock=!1,w._unlocked=!0,i?s._loadQueue():s._emit("play",f._id)}).catch(function(){s._playLock=!1,s._emit("playerror",f._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),f._ended=!0,f._paused=!0})):i||(s._playLock=!1,de(),s._emit("play",f._id)),w.playbackRate=f._rate,w.paused){s._emit("playerror",f._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");return}t!=="__default"||f._loop?s._endTimers[f._id]=setTimeout(s._ended.bind(s,f),M):(s._endTimers[f._id]=function(){s._ended(f),w.removeEventListener("ended",s._endTimers[f._id],!1)},w.addEventListener("ended",s._endTimers[f._id],!1))}catch(mt){s._emit("playerror",f._id,mt)}};w.src==="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"&&(w.src=s._src,w.load());var _t=window&&window.ejecta||!w.readyState&&e._navigator.isCocoonJS;if(w.readyState>=3||_t)Ie();else{s._playLock=!0,s._state="loading";var Re=function(){s._state="loaded",Ie(),w.removeEventListener(e._canPlayEvent,Re,!1)};w.addEventListener(e._canPlayEvent,Re,!1),s._clearTimer(f._id)}}return f._id},pause:function(t){var i=this;if(i._state!=="loaded"||i._playLock)return i._queue.push({event:"pause",action:function(){i.pause(t)}}),i;for(var s=i._getSoundIds(t),d=0;d<s.length;d++){i._clearTimer(s[d]);var _=i._soundById(s[d]);if(_&&!_._paused&&(_._seek=i.seek(s[d]),_._rateSeek=0,_._paused=!0,i._stopFade(s[d]),_._node))if(i._webAudio){if(!_._node.bufferSource)continue;typeof _._node.bufferSource.stop>"u"?_._node.bufferSource.noteOff(0):_._node.bufferSource.stop(0),i._cleanBuffer(_._node)}else(!isNaN(_._node.duration)||_._node.duration===1/0)&&_._node.pause();arguments[1]||i._emit("pause",_?_._id:null)}return i},stop:function(t,i){var s=this;if(s._state!=="loaded"||s._playLock)return s._queue.push({event:"stop",action:function(){s.stop(t)}}),s;for(var d=s._getSoundIds(t),_=0;_<d.length;_++){s._clearTimer(d[_]);var m=s._soundById(d[_]);m&&(m._seek=m._start||0,m._rateSeek=0,m._paused=!0,m._ended=!0,s._stopFade(d[_]),m._node&&(s._webAudio?m._node.bufferSource&&(typeof m._node.bufferSource.stop>"u"?m._node.bufferSource.noteOff(0):m._node.bufferSource.stop(0),s._cleanBuffer(m._node)):(!isNaN(m._node.duration)||m._node.duration===1/0)&&(m._node.currentTime=m._start||0,m._node.pause(),m._node.duration===1/0&&s._clearSound(m._node))),i||s._emit("stop",m._id))}return s},mute:function(t,i){var s=this;if(s._state!=="loaded"||s._playLock)return s._queue.push({event:"mute",action:function(){s.mute(t,i)}}),s;if(typeof i>"u")if(typeof t=="boolean")s._muted=t;else return s._muted;for(var d=s._getSoundIds(i),_=0;_<d.length;_++){var m=s._soundById(d[_]);m&&(m._muted=t,m._interval&&s._stopFade(m._id),s._webAudio&&m._node?m._node.gain.setValueAtTime(t?0:m._volume,e.ctx.currentTime):m._node&&(m._node.muted=e._muted?!0:t),s._emit("mute",m._id))}return s},volume:function(){var t=this,i=arguments,s,d;if(i.length===0)return t._volume;if(i.length===1||i.length===2&&typeof i[1]>"u"){var _=t._getSoundIds(),m=_.indexOf(i[0]);m>=0?d=parseInt(i[0],10):s=parseFloat(i[0])}else i.length>=2&&(s=parseFloat(i[0]),d=parseInt(i[1],10));var f;if(typeof s<"u"&&s>=0&&s<=1){if(t._state!=="loaded"||t._playLock)return t._queue.push({event:"volume",action:function(){t.volume.apply(t,i)}}),t;typeof d>"u"&&(t._volume=s),d=t._getSoundIds(d);for(var v=0;v<d.length;v++)f=t._soundById(d[v]),f&&(f._volume=s,i[2]||t._stopFade(d[v]),t._webAudio&&f._node&&!f._muted?f._node.gain.setValueAtTime(s,e.ctx.currentTime):f._node&&!f._muted&&(f._node.volume=s*e.volume()),t._emit("volume",f._id))}else return f=d?t._soundById(d):t._sounds[0],f?f._volume:0;return t},fade:function(t,i,s,d){var _=this;if(_._state!=="loaded"||_._playLock)return _._queue.push({event:"fade",action:function(){_.fade(t,i,s,d)}}),_;t=Math.min(Math.max(0,parseFloat(t)),1),i=Math.min(Math.max(0,parseFloat(i)),1),s=parseFloat(s),_.volume(t,d);for(var m=_._getSoundIds(d),f=0;f<m.length;f++){var v=_._soundById(m[f]);if(v){if(d||_._stopFade(m[f]),_._webAudio&&!v._muted){var T=e.ctx.currentTime,S=T+s/1e3;v._volume=t,v._node.gain.setValueAtTime(t,T),v._node.gain.linearRampToValueAtTime(i,S)}_._startFadeInterval(v,t,i,s,m[f],typeof d>"u")}}return _},_startFadeInterval:function(t,i,s,d,_,m){var f=this,v=i,T=s-i,S=Math.abs(T/.01),M=Math.max(4,S>0?d/S:d),V=Date.now();t._fadeTo=s,t._interval=setInterval(function(){var Q=(Date.now()-V)/d;V=Date.now(),v+=T*Q,v=Math.round(v*100)/100,T<0?v=Math.max(s,v):v=Math.min(s,v),f._webAudio?t._volume=v:f.volume(v,t._id,!0),m&&(f._volume=v),(s<i&&v<=s||s>i&&v>=s)&&(clearInterval(t._interval),t._interval=null,t._fadeTo=null,f.volume(s,t._id),f._emit("fade",t._id))},M)},_stopFade:function(t){var i=this,s=i._soundById(t);return s&&s._interval&&(i._webAudio&&s._node.gain.cancelScheduledValues(e.ctx.currentTime),clearInterval(s._interval),s._interval=null,i.volume(s._fadeTo,t),s._fadeTo=null,i._emit("fade",t)),i},loop:function(){var t=this,i=arguments,s,d,_;if(i.length===0)return t._loop;if(i.length===1)if(typeof i[0]=="boolean")s=i[0],t._loop=s;else return _=t._soundById(parseInt(i[0],10)),_?_._loop:!1;else i.length===2&&(s=i[0],d=parseInt(i[1],10));for(var m=t._getSoundIds(d),f=0;f<m.length;f++)_=t._soundById(m[f]),_&&(_._loop=s,t._webAudio&&_._node&&_._node.bufferSource&&(_._node.bufferSource.loop=s,s&&(_._node.bufferSource.loopStart=_._start||0,_._node.bufferSource.loopEnd=_._stop,t.playing(m[f])&&(t.pause(m[f],!0),t.play(m[f],!0)))));return t},rate:function(){var t=this,i=arguments,s,d;if(i.length===0)d=t._sounds[0]._id;else if(i.length===1){var _=t._getSoundIds(),m=_.indexOf(i[0]);m>=0?d=parseInt(i[0],10):s=parseFloat(i[0])}else i.length===2&&(s=parseFloat(i[0]),d=parseInt(i[1],10));var f;if(typeof s=="number"){if(t._state!=="loaded"||t._playLock)return t._queue.push({event:"rate",action:function(){t.rate.apply(t,i)}}),t;typeof d>"u"&&(t._rate=s),d=t._getSoundIds(d);for(var v=0;v<d.length;v++)if(f=t._soundById(d[v]),f){t.playing(d[v])&&(f._rateSeek=t.seek(d[v]),f._playStart=t._webAudio?e.ctx.currentTime:f._playStart),f._rate=s,t._webAudio&&f._node&&f._node.bufferSource?f._node.bufferSource.playbackRate.setValueAtTime(s,e.ctx.currentTime):f._node&&(f._node.playbackRate=s);var T=t.seek(d[v]),S=(t._sprite[f._sprite][0]+t._sprite[f._sprite][1])/1e3-T,M=S*1e3/Math.abs(f._rate);(t._endTimers[d[v]]||!f._paused)&&(t._clearTimer(d[v]),t._endTimers[d[v]]=setTimeout(t._ended.bind(t,f),M)),t._emit("rate",f._id)}}else return f=t._soundById(d),f?f._rate:t._rate;return t},seek:function(){var t=this,i=arguments,s,d;if(i.length===0)t._sounds.length&&(d=t._sounds[0]._id);else if(i.length===1){var _=t._getSoundIds(),m=_.indexOf(i[0]);m>=0?d=parseInt(i[0],10):t._sounds.length&&(d=t._sounds[0]._id,s=parseFloat(i[0]))}else i.length===2&&(s=parseFloat(i[0]),d=parseInt(i[1],10));if(typeof d>"u")return 0;if(typeof s=="number"&&(t._state!=="loaded"||t._playLock))return t._queue.push({event:"seek",action:function(){t.seek.apply(t,i)}}),t;var f=t._soundById(d);if(f)if(typeof s=="number"&&s>=0){var v=t.playing(d);v&&t.pause(d,!0),f._seek=s,f._ended=!1,t._clearTimer(d),!t._webAudio&&f._node&&!isNaN(f._node.duration)&&(f._node.currentTime=s);var T=function(){v&&t.play(d,!0),t._emit("seek",d)};if(v&&!t._webAudio){var S=function(){t._playLock?setTimeout(S,0):T()};setTimeout(S,0)}else T()}else if(t._webAudio){var M=t.playing(d)?e.ctx.currentTime-f._playStart:0,V=f._rateSeek?f._rateSeek-f._seek:0;return f._seek+(V+M*Math.abs(f._rate))}else return f._node.currentTime;return t},playing:function(t){var i=this;if(typeof t=="number"){var s=i._soundById(t);return s?!s._paused:!1}for(var d=0;d<i._sounds.length;d++)if(!i._sounds[d]._paused)return!0;return!1},duration:function(t){var i=this,s=i._duration,d=i._soundById(t);return d&&(s=i._sprite[d._sprite][1]/1e3),s},state:function(){return this._state},unload:function(){for(var t=this,i=t._sounds,s=0;s<i.length;s++)i[s]._paused||t.stop(i[s]._id),t._webAudio||(t._clearSound(i[s]._node),i[s]._node.removeEventListener("error",i[s]._errorFn,!1),i[s]._node.removeEventListener(e._canPlayEvent,i[s]._loadFn,!1),i[s]._node.removeEventListener("ended",i[s]._endFn,!1),e._releaseHtml5Audio(i[s]._node)),delete i[s]._node,t._clearTimer(i[s]._id);var d=e._howls.indexOf(t);d>=0&&e._howls.splice(d,1);var _=!0;for(s=0;s<e._howls.length;s++)if(e._howls[s]._src===t._src||t._src.indexOf(e._howls[s]._src)>=0){_=!1;break}return c&&_&&delete c[t._src],e.noAudio=!1,t._state="unloaded",t._sounds=[],t=null,null},on:function(t,i,s,d){var _=this,m=_["_on"+t];return typeof i=="function"&&m.push(d?{id:s,fn:i,once:d}:{id:s,fn:i}),_},off:function(t,i,s){var d=this,_=d["_on"+t],m=0;if(typeof i=="number"&&(s=i,i=null),i||s)for(m=0;m<_.length;m++){var f=s===_[m].id;if(i===_[m].fn&&f||!i&&f){_.splice(m,1);break}}else if(t)d["_on"+t]=[];else{var v=Object.keys(d);for(m=0;m<v.length;m++)v[m].indexOf("_on")===0&&Array.isArray(d[v[m]])&&(d[v[m]]=[])}return d},once:function(t,i,s){var d=this;return d.on(t,i,s,1),d},_emit:function(t,i,s){for(var d=this,_=d["_on"+t],m=_.length-1;m>=0;m--)(!_[m].id||_[m].id===i||t==="load")&&(setTimeout((function(f){f.call(this,i,s)}).bind(d,_[m].fn),0),_[m].once&&d.off(t,_[m].fn,_[m].id));return d._loadQueue(t),d},_loadQueue:function(t){var i=this;if(i._queue.length>0){var s=i._queue[0];s.event===t&&(i._queue.shift(),i._loadQueue()),t||s.action()}return i},_ended:function(t){var i=this,s=t._sprite;if(!i._webAudio&&t._node&&!t._node.paused&&!t._node.ended&&t._node.currentTime<t._stop)return setTimeout(i._ended.bind(i,t),100),i;var d=!!(t._loop||i._sprite[s][2]);if(i._emit("end",t._id),!i._webAudio&&d&&i.stop(t._id,!0).play(t._id),i._webAudio&&d){i._emit("play",t._id),t._seek=t._start||0,t._rateSeek=0,t._playStart=e.ctx.currentTime;var _=(t._stop-t._start)*1e3/Math.abs(t._rate);i._endTimers[t._id]=setTimeout(i._ended.bind(i,t),_)}return i._webAudio&&!d&&(t._paused=!0,t._ended=!0,t._seek=t._start||0,t._rateSeek=0,i._clearTimer(t._id),i._cleanBuffer(t._node),e._autoSuspend()),!i._webAudio&&!d&&i.stop(t._id,!0),i},_clearTimer:function(t){var i=this;if(i._endTimers[t]){if(typeof i._endTimers[t]!="function")clearTimeout(i._endTimers[t]);else{var s=i._soundById(t);s&&s._node&&s._node.removeEventListener("ended",i._endTimers[t],!1)}delete i._endTimers[t]}return i},_soundById:function(t){for(var i=this,s=0;s<i._sounds.length;s++)if(t===i._sounds[s]._id)return i._sounds[s];return null},_inactiveSound:function(){var t=this;t._drain();for(var i=0;i<t._sounds.length;i++)if(t._sounds[i]._ended)return t._sounds[i].reset();return new a(t)},_drain:function(){var t=this,i=t._pool,s=0,d=0;if(!(t._sounds.length<i)){for(d=0;d<t._sounds.length;d++)t._sounds[d]._ended&&s++;for(d=t._sounds.length-1;d>=0;d--){if(s<=i)return;t._sounds[d]._ended&&(t._webAudio&&t._sounds[d]._node&&t._sounds[d]._node.disconnect(0),t._sounds.splice(d,1),s--)}}},_getSoundIds:function(t){var i=this;if(typeof t>"u"){for(var s=[],d=0;d<i._sounds.length;d++)s.push(i._sounds[d]._id);return s}else return[t]},_refreshBuffer:function(t){var i=this;return t._node.bufferSource=e.ctx.createBufferSource(),t._node.bufferSource.buffer=c[i._src],t._panner?t._node.bufferSource.connect(t._panner):t._node.bufferSource.connect(t._node),t._node.bufferSource.loop=t._loop,t._loop&&(t._node.bufferSource.loopStart=t._start||0,t._node.bufferSource.loopEnd=t._stop||0),t._node.bufferSource.playbackRate.setValueAtTime(t._rate,e.ctx.currentTime),i},_cleanBuffer:function(t){var i=this,s=e._navigator&&e._navigator.vendor.indexOf("Apple")>=0;if(!t.bufferSource)return i;if(e._scratchBuffer&&t.bufferSource&&(t.bufferSource.onended=null,t.bufferSource.disconnect(0),s))try{t.bufferSource.buffer=e._scratchBuffer}catch{}return t.bufferSource=null,i},_clearSound:function(t){var i=/MSIE |Trident\//.test(e._navigator&&e._navigator.userAgent);i||(t.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA")}};var a=function(t){this._parent=t,this.init()};a.prototype={init:function(){var t=this,i=t._parent;return t._muted=i._muted,t._loop=i._loop,t._volume=i._volume,t._rate=i._rate,t._seek=0,t._paused=!0,t._ended=!0,t._sprite="__default",t._id=++e._counter,i._sounds.push(t),t.create(),t},create:function(){var t=this,i=t._parent,s=e._muted||t._muted||t._parent._muted?0:t._volume;return i._webAudio?(t._node=typeof e.ctx.createGain>"u"?e.ctx.createGainNode():e.ctx.createGain(),t._node.gain.setValueAtTime(s,e.ctx.currentTime),t._node.paused=!0,t._node.connect(e.masterGain)):e.noAudio||(t._node=e._obtainHtml5Audio(),t._errorFn=t._errorListener.bind(t),t._node.addEventListener("error",t._errorFn,!1),t._loadFn=t._loadListener.bind(t),t._node.addEventListener(e._canPlayEvent,t._loadFn,!1),t._endFn=t._endListener.bind(t),t._node.addEventListener("ended",t._endFn,!1),t._node.src=i._src,t._node.preload=i._preload===!0?"auto":i._preload,t._node.volume=s*e.volume(),t._node.load()),t},reset:function(){var t=this,i=t._parent;return t._muted=i._muted,t._loop=i._loop,t._volume=i._volume,t._rate=i._rate,t._seek=0,t._rateSeek=0,t._paused=!0,t._ended=!0,t._sprite="__default",t._id=++e._counter,t},_errorListener:function(){var t=this;t._parent._emit("loaderror",t._id,t._node.error?t._node.error.code:0),t._node.removeEventListener("error",t._errorFn,!1)},_loadListener:function(){var t=this,i=t._parent;i._duration=Math.ceil(t._node.duration*10)/10,Object.keys(i._sprite).length===0&&(i._sprite={__default:[0,i._duration*1e3]}),i._state!=="loaded"&&(i._state="loaded",i._emit("load"),i._loadQueue()),t._node.removeEventListener(e._canPlayEvent,t._loadFn,!1)},_endListener:function(){var t=this,i=t._parent;i._duration===1/0&&(i._duration=Math.ceil(t._node.duration*10)/10,i._sprite.__default[1]===1/0&&(i._sprite.__default[1]=i._duration*1e3),i._ended(t)),t._node.removeEventListener("ended",t._endFn,!1)}};var c={},l=function(t){var i=t._src;if(c[i]){t._duration=c[i].duration,y(t);return}if(/^data:[^;]+;base64,/.test(i)){for(var s=atob(i.split(",")[1]),d=new Uint8Array(s.length),_=0;_<s.length;++_)d[_]=s.charCodeAt(_);h(d.buffer,t)}else{var m=new XMLHttpRequest;m.open(t._xhr.method,i,!0),m.withCredentials=t._xhr.withCredentials,m.responseType="arraybuffer",t._xhr.headers&&Object.keys(t._xhr.headers).forEach(function(f){m.setRequestHeader(f,t._xhr.headers[f])}),m.onload=function(){var f=(m.status+"")[0];if(f!=="0"&&f!=="2"&&f!=="3"){t._emit("loaderror",null,"Failed loading audio file with status: "+m.status+".");return}h(m.response,t)},m.onerror=function(){t._webAudio&&(t._html5=!0,t._webAudio=!1,t._sounds=[],delete c[i],t.load())},p(m)}},p=function(t){try{t.send()}catch{t.onerror()}},h=function(t,i){var s=function(){i._emit("loaderror",null,"Decoding audio data failed.")},d=function(_){_&&i._sounds.length>0?(c[i._src]=_,y(i,_)):s()};typeof Promise<"u"&&e.ctx.decodeAudioData.length===1?e.ctx.decodeAudioData(t).then(d).catch(s):e.ctx.decodeAudioData(t,d,s)},y=function(t,i){i&&!t._duration&&(t._duration=i.duration),Object.keys(t._sprite).length===0&&(t._sprite={__default:[0,t._duration*1e3]}),t._state!=="loaded"&&(t._state="loaded",t._emit("load"),t._loadQueue())},E=function(){if(e.usingWebAudio){try{typeof AudioContext<"u"?e.ctx=new AudioContext:typeof webkitAudioContext<"u"?e.ctx=new webkitAudioContext:e.usingWebAudio=!1}catch{e.usingWebAudio=!1}e.ctx||(e.usingWebAudio=!1);var t=/iP(hone|od|ad)/.test(e._navigator&&e._navigator.platform),i=e._navigator&&e._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),s=i?parseInt(i[1],10):null;if(t&&s&&s<9){var d=/safari/.test(e._navigator&&e._navigator.userAgent.toLowerCase());e._navigator&&!d&&(e.usingWebAudio=!1)}e.usingWebAudio&&(e.masterGain=typeof e.ctx.createGain>"u"?e.ctx.createGainNode():e.ctx.createGain(),e.masterGain.gain.setValueAtTime(e._muted?0:e._volume,e.ctx.currentTime),e.masterGain.connect(e.ctx.destination)),e._setup()}};o.Howler=e,o.Howl=r,typeof q<"u"?(q.HowlerGlobal=n,q.Howler=e,q.Howl=r,q.Sound=a):typeof window<"u"&&(window.HowlerGlobal=n,window.Howler=e,window.Howl=r,window.Sound=a)})();(function(){HowlerGlobal.prototype._pos=[0,0,0],HowlerGlobal.prototype._orientation=[0,0,-1,0,1,0],HowlerGlobal.prototype.stereo=function(e){var r=this;if(!r.ctx||!r.ctx.listener)return r;for(var a=r._howls.length-1;a>=0;a--)r._howls[a].stereo(e);return r},HowlerGlobal.prototype.pos=function(e,r,a){var c=this;if(!c.ctx||!c.ctx.listener)return c;if(r=typeof r!="number"?c._pos[1]:r,a=typeof a!="number"?c._pos[2]:a,typeof e=="number")c._pos=[e,r,a],typeof c.ctx.listener.positionX<"u"?(c.ctx.listener.positionX.setTargetAtTime(c._pos[0],Howler.ctx.currentTime,.1),c.ctx.listener.positionY.setTargetAtTime(c._pos[1],Howler.ctx.currentTime,.1),c.ctx.listener.positionZ.setTargetAtTime(c._pos[2],Howler.ctx.currentTime,.1)):c.ctx.listener.setPosition(c._pos[0],c._pos[1],c._pos[2]);else return c._pos;return c},HowlerGlobal.prototype.orientation=function(e,r,a,c,l,p){var h=this;if(!h.ctx||!h.ctx.listener)return h;var y=h._orientation;if(r=typeof r!="number"?y[1]:r,a=typeof a!="number"?y[2]:a,c=typeof c!="number"?y[3]:c,l=typeof l!="number"?y[4]:l,p=typeof p!="number"?y[5]:p,typeof e=="number")h._orientation=[e,r,a,c,l,p],typeof h.ctx.listener.forwardX<"u"?(h.ctx.listener.forwardX.setTargetAtTime(e,Howler.ctx.currentTime,.1),h.ctx.listener.forwardY.setTargetAtTime(r,Howler.ctx.currentTime,.1),h.ctx.listener.forwardZ.setTargetAtTime(a,Howler.ctx.currentTime,.1),h.ctx.listener.upX.setTargetAtTime(c,Howler.ctx.currentTime,.1),h.ctx.listener.upY.setTargetAtTime(l,Howler.ctx.currentTime,.1),h.ctx.listener.upZ.setTargetAtTime(p,Howler.ctx.currentTime,.1)):h.ctx.listener.setOrientation(e,r,a,c,l,p);else return y;return h},Howl.prototype.init=(function(e){return function(r){var a=this;return a._orientation=r.orientation||[1,0,0],a._stereo=r.stereo||null,a._pos=r.pos||null,a._pannerAttr={coneInnerAngle:typeof r.coneInnerAngle<"u"?r.coneInnerAngle:360,coneOuterAngle:typeof r.coneOuterAngle<"u"?r.coneOuterAngle:360,coneOuterGain:typeof r.coneOuterGain<"u"?r.coneOuterGain:0,distanceModel:typeof r.distanceModel<"u"?r.distanceModel:"inverse",maxDistance:typeof r.maxDistance<"u"?r.maxDistance:1e4,panningModel:typeof r.panningModel<"u"?r.panningModel:"HRTF",refDistance:typeof r.refDistance<"u"?r.refDistance:1,rolloffFactor:typeof r.rolloffFactor<"u"?r.rolloffFactor:1},a._onstereo=r.onstereo?[{fn:r.onstereo}]:[],a._onpos=r.onpos?[{fn:r.onpos}]:[],a._onorientation=r.onorientation?[{fn:r.onorientation}]:[],e.call(this,r)}})(Howl.prototype.init),Howl.prototype.stereo=function(e,r){var a=this;if(!a._webAudio)return a;if(a._state!=="loaded")return a._queue.push({event:"stereo",action:function(){a.stereo(e,r)}}),a;var c=typeof Howler.ctx.createStereoPanner>"u"?"spatial":"stereo";if(typeof r>"u")if(typeof e=="number")a._stereo=e,a._pos=[e,0,0];else return a._stereo;for(var l=a._getSoundIds(r),p=0;p<l.length;p++){var h=a._soundById(l[p]);if(h)if(typeof e=="number")h._stereo=e,h._pos=[e,0,0],h._node&&(h._pannerAttr.panningModel="equalpower",(!h._panner||!h._panner.pan)&&n(h,c),c==="spatial"?typeof h._panner.positionX<"u"?(h._panner.positionX.setValueAtTime(e,Howler.ctx.currentTime),h._panner.positionY.setValueAtTime(0,Howler.ctx.currentTime),h._panner.positionZ.setValueAtTime(0,Howler.ctx.currentTime)):h._panner.setPosition(e,0,0):h._panner.pan.setValueAtTime(e,Howler.ctx.currentTime)),a._emit("stereo",h._id);else return h._stereo}return a},Howl.prototype.pos=function(e,r,a,c){var l=this;if(!l._webAudio)return l;if(l._state!=="loaded")return l._queue.push({event:"pos",action:function(){l.pos(e,r,a,c)}}),l;if(r=typeof r!="number"?0:r,a=typeof a!="number"?-.5:a,typeof c>"u")if(typeof e=="number")l._pos=[e,r,a];else return l._pos;for(var p=l._getSoundIds(c),h=0;h<p.length;h++){var y=l._soundById(p[h]);if(y)if(typeof e=="number")y._pos=[e,r,a],y._node&&((!y._panner||y._panner.pan)&&n(y,"spatial"),typeof y._panner.positionX<"u"?(y._panner.positionX.setValueAtTime(e,Howler.ctx.currentTime),y._panner.positionY.setValueAtTime(r,Howler.ctx.currentTime),y._panner.positionZ.setValueAtTime(a,Howler.ctx.currentTime)):y._panner.setPosition(e,r,a)),l._emit("pos",y._id);else return y._pos}return l},Howl.prototype.orientation=function(e,r,a,c){var l=this;if(!l._webAudio)return l;if(l._state!=="loaded")return l._queue.push({event:"orientation",action:function(){l.orientation(e,r,a,c)}}),l;if(r=typeof r!="number"?l._orientation[1]:r,a=typeof a!="number"?l._orientation[2]:a,typeof c>"u")if(typeof e=="number")l._orientation=[e,r,a];else return l._orientation;for(var p=l._getSoundIds(c),h=0;h<p.length;h++){var y=l._soundById(p[h]);if(y)if(typeof e=="number")y._orientation=[e,r,a],y._node&&(y._panner||(y._pos||(y._pos=l._pos||[0,0,-.5]),n(y,"spatial")),typeof y._panner.orientationX<"u"?(y._panner.orientationX.setValueAtTime(e,Howler.ctx.currentTime),y._panner.orientationY.setValueAtTime(r,Howler.ctx.currentTime),y._panner.orientationZ.setValueAtTime(a,Howler.ctx.currentTime)):y._panner.setOrientation(e,r,a)),l._emit("orientation",y._id);else return y._orientation}return l},Howl.prototype.pannerAttr=function(){var e=this,r=arguments,a,c,l;if(!e._webAudio)return e;if(r.length===0)return e._pannerAttr;if(r.length===1)if(typeof r[0]=="object")a=r[0],typeof c>"u"&&(a.pannerAttr||(a.pannerAttr={coneInnerAngle:a.coneInnerAngle,coneOuterAngle:a.coneOuterAngle,coneOuterGain:a.coneOuterGain,distanceModel:a.distanceModel,maxDistance:a.maxDistance,refDistance:a.refDistance,rolloffFactor:a.rolloffFactor,panningModel:a.panningModel}),e._pannerAttr={coneInnerAngle:typeof a.pannerAttr.coneInnerAngle<"u"?a.pannerAttr.coneInnerAngle:e._coneInnerAngle,coneOuterAngle:typeof a.pannerAttr.coneOuterAngle<"u"?a.pannerAttr.coneOuterAngle:e._coneOuterAngle,coneOuterGain:typeof a.pannerAttr.coneOuterGain<"u"?a.pannerAttr.coneOuterGain:e._coneOuterGain,distanceModel:typeof a.pannerAttr.distanceModel<"u"?a.pannerAttr.distanceModel:e._distanceModel,maxDistance:typeof a.pannerAttr.maxDistance<"u"?a.pannerAttr.maxDistance:e._maxDistance,refDistance:typeof a.pannerAttr.refDistance<"u"?a.pannerAttr.refDistance:e._refDistance,rolloffFactor:typeof a.pannerAttr.rolloffFactor<"u"?a.pannerAttr.rolloffFactor:e._rolloffFactor,panningModel:typeof a.pannerAttr.panningModel<"u"?a.pannerAttr.panningModel:e._panningModel});else return l=e._soundById(parseInt(r[0],10)),l?l._pannerAttr:e._pannerAttr;else r.length===2&&(a=r[0],c=parseInt(r[1],10));for(var p=e._getSoundIds(c),h=0;h<p.length;h++)if(l=e._soundById(p[h]),l){var y=l._pannerAttr;y={coneInnerAngle:typeof a.coneInnerAngle<"u"?a.coneInnerAngle:y.coneInnerAngle,coneOuterAngle:typeof a.coneOuterAngle<"u"?a.coneOuterAngle:y.coneOuterAngle,coneOuterGain:typeof a.coneOuterGain<"u"?a.coneOuterGain:y.coneOuterGain,distanceModel:typeof a.distanceModel<"u"?a.distanceModel:y.distanceModel,maxDistance:typeof a.maxDistance<"u"?a.maxDistance:y.maxDistance,refDistance:typeof a.refDistance<"u"?a.refDistance:y.refDistance,rolloffFactor:typeof a.rolloffFactor<"u"?a.rolloffFactor:y.rolloffFactor,panningModel:typeof a.panningModel<"u"?a.panningModel:y.panningModel};var E=l._panner;E||(l._pos||(l._pos=e._pos||[0,0,-.5]),n(l,"spatial"),E=l._panner),E.coneInnerAngle=y.coneInnerAngle,E.coneOuterAngle=y.coneOuterAngle,E.coneOuterGain=y.coneOuterGain,E.distanceModel=y.distanceModel,E.maxDistance=y.maxDistance,E.refDistance=y.refDistance,E.rolloffFactor=y.rolloffFactor,E.panningModel=y.panningModel}return e},Sound.prototype.init=(function(e){return function(){var r=this,a=r._parent;r._orientation=a._orientation,r._stereo=a._stereo,r._pos=a._pos,r._pannerAttr=a._pannerAttr,e.call(this),r._stereo?a.stereo(r._stereo):r._pos&&a.pos(r._pos[0],r._pos[1],r._pos[2],r._id)}})(Sound.prototype.init),Sound.prototype.reset=(function(e){return function(){var r=this,a=r._parent;return r._orientation=a._orientation,r._stereo=a._stereo,r._pos=a._pos,r._pannerAttr=a._pannerAttr,r._stereo?a.stereo(r._stereo):r._pos?a.pos(r._pos[0],r._pos[1],r._pos[2],r._id):r._panner&&(r._panner.disconnect(0),r._panner=void 0,a._refreshBuffer(r)),e.call(this)}})(Sound.prototype.reset);var n=function(e,r){r=r||"spatial",r==="spatial"?(e._panner=Howler.ctx.createPanner(),e._panner.coneInnerAngle=e._pannerAttr.coneInnerAngle,e._panner.coneOuterAngle=e._pannerAttr.coneOuterAngle,e._panner.coneOuterGain=e._pannerAttr.coneOuterGain,e._panner.distanceModel=e._pannerAttr.distanceModel,e._panner.maxDistance=e._pannerAttr.maxDistance,e._panner.refDistance=e._pannerAttr.refDistance,e._panner.rolloffFactor=e._pannerAttr.rolloffFactor,e._panner.panningModel=e._pannerAttr.panningModel,typeof e._panner.positionX<"u"?(e._panner.positionX.setValueAtTime(e._pos[0],Howler.ctx.currentTime),e._panner.positionY.setValueAtTime(e._pos[1],Howler.ctx.currentTime),e._panner.positionZ.setValueAtTime(e._pos[2],Howler.ctx.currentTime)):e._panner.setPosition(e._pos[0],e._pos[1],e._pos[2]),typeof e._panner.orientationX<"u"?(e._panner.orientationX.setValueAtTime(e._orientation[0],Howler.ctx.currentTime),e._panner.orientationY.setValueAtTime(e._orientation[1],Howler.ctx.currentTime),e._panner.orientationZ.setValueAtTime(e._orientation[2],Howler.ctx.currentTime)):e._panner.setOrientation(e._orientation[0],e._orientation[1],e._orientation[2])):(e._panner=Howler.ctx.createStereoPanner(),e._panner.pan.setValueAtTime(e._stereo,Howler.ctx.currentTime)),e._panner.connect(e._node),e._paused||e._parent.pause(e._id,!0).play(e._id,!0)}})()})(fe)),fe}var J=wt();const gt=""+new URL("drill-xLKvMt-A.mp3",import.meta.url).href,St=""+new URL("music-DSNgN0lF.mp3",import.meta.url).href,xt=""+new URL("visual_scan-RCRND52a.mp3",import.meta.url).href,It=""+new URL("track-move-CJfuB3pn.mp3",import.meta.url).href;class Rt{sounds;constructor(){this.sounds={drill:new J.Howl({src:[gt]}),music:new J.Howl({src:[St],volume:.1,loop:!0}),visual_scan:new J.Howl({src:[xt]}),track_move:new J.Howl({src:[It],volume:.5,loop:!0})}}music(){this.sounds.music.playing()||this.sounds.music.play()}play(n,e){const r=this.sounds[n];return r.pos(e[0],e[1],.5),r.play()}moveSound(n,e,r){this.sounds[e].pos(r[0],r[1],.5,n)}stopSound(n,e){this.sounds[e].stop(n)}}const ne=new Rt,Xe="ACTION_ADD",Te="ACTION_REMOVE";class he{id;type;delta;value;timeEnd;entityId;parentId;result;state={};soundName;soundId;continueSound;isSilent=!1;isComplete=!1;isStarted=!1;isCancelled=!1;shouldCancel=!1;children;constructor(n,{delta:e,value:r,timeEnd:a,entityId:c},l=!1,p){this.type=n,this.delta=e,this.value=r,this.timeEnd=a,this.entityId=c,this.id=crypto.randomUUID(),this.isSilent=l,this.parentId=p,this.type==="ROTATE"&&(this.value=Math.max(-3,Math.min(3,this.value||1))),this.type==="MOVE"&&(this.value=Math.max(0,Math.min(g,r||0)))}complete(n){this.result=n,this.isComplete=!0,this.stopSound()}start(){this.isStarted=!0}cancel(){this.isStarted?this.shouldCancel=!0:this.isCancelled=!0,this.stopSound()}stopSound(){!this.soundId||this.continueSound||ne.stopSound(this.soundId,this.soundName)}addSound(n,e){this.soundId||(this.soundName=n,this.soundId=ne.play(n,e),this.children?.length&&(this.continueSound=!0,this.children=this.children.map((r,a,c)=>(r.soundId=this.soundId,r.soundName=this.soundName,r.continueSound=a<c.length-1,r))))}moveSound(n){this.soundName&&this.soundId&&ne.moveSound(this.soundId,this.soundName,n)}addChildren(n){this.children=n,this.continueSound=!1}}class Me{stack;mapUpdates;mapChanges;hook;constructor(){this.stack=[],this.mapUpdates=[],this.mapChanges=[],this.hook=new EventTarget}getActions(){return this.stack.filter(e=>e.isComplete).forEach(e=>{this.hook.dispatchEvent(new CustomEvent(Te,{detail:e}))}),this.stack=[...this.stack.filter(e=>!e.isComplete&&!e.isCancelled)],this.stack}addAction(n,{delta:e,value:r,timeEnd:a,entityId:c}){const l=new he(n,{delta:e,value:r,timeEnd:a,entityId:c});return this.stack.push(l),this.hook.dispatchEvent(new CustomEvent(Xe,{detail:l})),l}addSilentAction(n,{delta:e,value:r,timeEnd:a,entityId:c},l){const p=new he(n,{delta:e,value:r,timeEnd:a,entityId:c},!0,l);return this.stack.push(p),p}cancelOneForEntity(n){const e=this.stack.find(a=>a.entityId===n);if(!e)return;const r=this.stack.filter(a=>a.parentId===e.id);return[e,...r].forEach(a=>a.cancel()),e}cancelAllForEntity(n){this.stack.filter(e=>e.entityId===n).forEach(e=>e.cancel())}getMapUpdates(){const n=[...this.mapUpdates];return this.mapUpdates=[],n}addMapUpdate(n){this.mapUpdates.push(n),this.mapChanges.push(n),Ye(n)}}const _e={RUN:["any","any","memory_or_null"],JMP:["label"],PUT:["number_memory","memory"],JEQ:["number_memory","number_memory","label"],JGT:["number_memory","number_memory","label"],JLT:["number_memory","number_memory","label"],JZE:["number_memory","label"],SUB:["number_memory","number_memory","memory"],MUL:["number_memory","number_memory","memory"],ADD:["number_memory","number_memory","memory"],DIV:["number_memory","number_memory","memory"],MOD:["number_memory","number_memory","memory"]},oe=/^[A-Za-z][A-Za-z_0-9]*\:/,me=/^M_\d+/,Ae={label:(o,n)=>!!o.labels?.includes(n),memory:(o,n)=>me.test(n),number_memory:(o,n)=>me.test(n)||/^\d+/.test(n),number:(o,n)=>/^\d+/.test(n),any:()=>!0,memory_or_null:(o,n)=>me.test(n)||n===void 0||n===""},Ot=o=>oe.test(o),Ct=o=>{const n=o.split(`
`),e={},r=n.reduce((l,p,h)=>{if(p=p.replace(/#.+/g,"").trim(),!p)return l;const[y]=p.split(" ");if(!_e[y]&&!oe.test(y))return l.push([h,"UNKNOWN"]),l;if(oe.test(y)){const E=y.replace(/:$/,"");if(e[E])return l.push([h,"DUPLICATE_LABEL"]),l;e[E]=h}return l},[]),a=n.reduce((l,p,h)=>{if(p=p.replace(/#.+/g,"").trim(),!p)return l;const[y,...E]=p.split(" ");if(oe.test(y))return l;if(_e[y]){const t=_e[y];if(!t)return l;if(E.length!==t.length)return l.push([h,"INVALID"]),l;for(let i=0;i<E.length;i++)Ae[t[i]]({labels:Object.keys(e)},E[i])||l.push([h,"INVALID",[i,t[i]]])}return l},r),c=n.map(l=>l.replace(/#.+/g,"").trim()).filter(Boolean).map(l=>{const[p,...h]=l.split(" ");return[p,h]});return[a.length?[]:c,a,e]},K=(o,[n])=>{const e=o.script.labels[n];o.navigateTo(e)},Lt=(o,n)=>{let[e,r]=n,a;Ae.number({},e)?a=parseInt(e):a=o.getMemory(e),a&&o.putMemory(r,a)},Mt=(o,n)=>{const[e,r,a]=n;let[c,l]=[e,r].map(p=>L(o,p));if(c===l)return K(o,[a])},Dt=(o,n)=>{const[e,r,a]=n;let[c,l]=[e,r].map(p=>L(o,p));if(c>l)return K(o,[a])},Nt=(o,n)=>{const[e,r,a]=n;let[c,l]=[e,r].map(p=>L(o,p));if(c<l)return K(o,[a])},kt=(o,n)=>{const[e,r]=n;if(L(o,e)===0)return K(o,[r])},Bt=(o,n)=>{const[e,r,a]=n;let[c,l]=[e,r].map(p=>L(o,p));o.putMemory(a,c-l)},Ft=(o,n)=>{const[e,r,a]=n;let[c,l]=[e,r].map(p=>L(o,p));o.putMemory(a,c+l)},Pt=(o,n)=>{const[e,r,a]=n;let[c,l]=[e,r].map(p=>L(o,p));o.putMemory(a,c*l)},Ut=(o,n)=>{const[e,r,a]=n;let[c,l]=[e,r].map(p=>L(o,p));o.putMemory(a,Math.round(c/l))},Ht=(o,n)=>{const[e,r,a]=n;let[c,l]=[e,r].map(p=>L(o,p));o.putMemory(a,c%l)},Vt=(o,n)=>{const[e,...r]=n,a=r.map(l=>L(o,l).toString()),c=it(o.entity.id,e,a);c&&o.awaitActions(c)},$t={JMP:K,PUT:Lt,JEQ:Mt,JGT:Dt,JLT:Nt,JZE:kt,SUB:Bt,ADD:Ft,MUL:Pt,DIV:Ut,MOD:Ht,RUN:Vt},L=(o,n)=>{let e;return Ae.number({},n)?e=parseInt(n):e=o.getMemory(n),e??0};class we{name;lines;content;errors;labels;constructor(n,e){const[r,a,c]=Ct(e);this.name=n,this.labels=c,this.lines=r,this.errors=a,this.content=e}}const Gt=500;class Wt{script;entity;lineIdx=0;actions;memory;execTime;isComplete=!1;constructor(n,e){this.entity=n,this.script=e,this.memory=[],this.actions=[],u.actions.hook.addEventListener(Te,r=>{const a=r.detail;this.actions=this.actions.filter(c=>c!==a.id)})}run(){if(this.lineIdx>=this.script.lines.length){this.isComplete=!0;return}if(this.execTime&&Date.now()<this.execTime||(this.execTime=Date.now()+Gt,this.actions.length))return;const[n,e]=this.script.lines[this.lineIdx];if(Ot(n))return this.lineIdx++,this.run();$t[n](this,e),this.lineIdx++}navigateTo(n){this.lineIdx=n}awaitActions(n){this.actions.push(...n)}getMemory(n){const e=parseInt(n.replace(/[^\d]+/,""));return isNaN(e)?0:this.memory[e]}putMemory(n,e){if(isNaN(e))return;const r=parseInt(n.replace(/[^\d]+/,""));isNaN(r)||(this.memory[r]=e)}}const qe=document.getElementById("editor-container"),ae=document.getElementById("editor"),je=document.getElementById("editor-name"),se=document.getElementById("editor-save"),Yt=document.getElementById("editor-cancel"),z=document.getElementById("editor-errors"),Xt=o=>{const n=u.scripts[o]??new we(o,"");ze(n)},ze=o=>{ae.classList.remove("hidden"),z.classList.add("hidden"),ae.value=o.content,je.textContent=o.name,z.innerHTML="",qe.classList.remove("hidden"),se.textContent="Save",se.addEventListener("click",qt,{once:!0})},qt=()=>{const o=ae.value,n=je.textContent??"UNKNOWN",e=new we(n,o);if(e.errors.length){z.innerHTML="",e.content.split(`
`).forEach((r,a)=>{const c=e.errors.find(p=>p[0]===a),l=document.createElement("p");if(c){const[p,h,y]=c,[E]=r.match(/^\s+/)??[],[t,...i]=r.trim().split(" ");l.append(document.createTextNode(E??""),...[t].filter(Boolean).map(s=>{const d=document.createElement("span");return d.classList.add("mr"),d.textContent=s,d}),...i.filter(Boolean).map((s,d)=>{const _=document.createElement("span");return y?.[0]===d&&(_.classList.add("err-arg"),_.title=y?.[1]??""),_.classList.add("mr"),_.textContent=s,_})),l.classList.add("is-error"),l.title=c[1]}else l.textContent=r;z.appendChild(l)}),se.textContent="Edit",se.addEventListener("click",()=>ze(e),{once:!0}),z.classList.remove("hidden"),ae.classList.add("hidden");return}u.saveScript(e),Ze()},Ze=()=>{qe.classList.add("hidden")};Yt.addEventListener("click",Ze);function Ke(o){console&&(console.error?console.error(o):console.log&&console.log(o))}const jt=/ERROR:\s*\d+:(\d+)/gi;function Qe(o,n=""){const e=[...n.matchAll(jt)],r=new Map(e.map((a,c)=>{const l=parseInt(a[1]),p=e[c+1],h=p?p.index:n.length,y=n.substring(a.index,h);return[l-1,y]}));return o.split(`
`).map((a,c)=>{const l=r.get(c);return`${c+1}: ${a}${l?`

^^^ ${l}`:""}`}).join(`
`)}function zt(o,n,e,r){const a=r||Ke,c=o.createShader(e);if(!c)return a("No shader"),null;if(o.shaderSource(c,n),o.compileShader(c),!o.getShaderParameter(c,o.COMPILE_STATUS)){const p=o.getShaderInfoLog(c);return a(`Error compiling shader: ${p}
${Qe(n,p??"")}`),o.deleteShader(c),null}return c}function Zt(o,n,e,r,a){const c=a||Ke,l=o.createProgram();if(!l)return null;if(n.forEach(function(h){o.attachShader(l,h)}),e&&e.forEach(function(h,y){o.bindAttribLocation(l,r?r[y]:y,h)}),o.linkProgram(l),!o.getProgramParameter(l,o.LINK_STATUS)){const h=o.getProgramInfoLog(l),y=n.map(E=>{const t=Qe(o.getShaderSource(E)??"");return`${o.getShaderParameter(E,o.SHADER_TYPE)}:
${t}`}).join(`
`);return c(`Error in program linking: ${h}
${y}`),o.deleteProgram(l),null}return l}const Kt=["VERTEX_SHADER","FRAGMENT_SHADER"];function Je(o,n,e=[],r=[],a=()=>{}){const c=[];for(let l=0;l<n.length;++l)c.push(zt(o,n[l],o[Kt[l]],a));return Zt(o,c.filter(Boolean),e,r,a)}function et(o,n){n=n||1;const e=o.clientWidth*n|0,r=o.clientHeight*n|0;return o.width!==e||o.height!==r?(o.width=e,o.height=r,!0):!1}let re={};const Qt=()=>{re={}},tt=async(o,n)=>{if(re[n])return re[n];const e=o.createTexture()??void 0;if(!e)throw new Error("Invalid texture");o.bindTexture(o.TEXTURE_2D,e);const r=new Image;return r.src=n,new Promise(a=>{r.onload=()=>{o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,r),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.LINEAR),o.bindTexture(o.TEXTURE_2D,null),re[n]=e,a(e)}})},Jt=`#version 300 es

// an attribute is an input (in) to a vertex shader.
// It will receive data from a buffer

in vec2 a_position;
in vec2 a_texcoord;

uniform int tileX;
uniform int tileW;
uniform float u_atlas_w;
uniform vec2 camera;

// Used to pass in the resolution of the canvas
uniform vec2 u_resolution;

uniform vec3 u_light[16];

uniform highp sampler2D u_data;

out vec2 v_texcoord;
out float bright;
out float b_type;
out float durability;
out float atlas_w;

bool get_solid(float x, float y) {
  ivec2 pos = ivec2(int(x), int(y));
  float t = texelFetch(u_data, pos, 0).b;
  return t == 1.0;
}

bool is_blocked (vec2 pos1, vec2 pos2, int dist) {
  float x1 = pos1.x;
  float y1 = pos1.y;
  float x2 = pos2.x;
  float y2 = pos2.y;

  float dx = abs(x1 - x2);
  float dy = abs(y1 - y2);
  float sx = sign(x1 - x2);
  float sy = sign(y1 - y2);
  float err = dx - dy;

  if (dx < 2.0 && dy < 2.0) {
    return false;
  }

  for (int i = 0; i < dist; i++) {
    if (x1 == x2 && y1 == y2) {
      return false;
    }
    float err2 = 2.0 * err;
    if (err2 > -dy) {
      err -= dy;
      x2 += sx;
    }
    if (err2 < dx) {
      err += dx;
      y2 += sy;
    }
    if (get_solid(x2, y2) == true) {
      return true;
    }
  }

  return false;
}

// all shaders have a main function
void main() {
  int row = int(floor(float(gl_InstanceID) / float(tileX)));
  int col = int(mod(float(gl_InstanceID), float(tileX)));

  bright = 0.1;
  for (int i = 0; i < 16; i++) {
    if (u_light[i].z > 0.0) {
      vec2 l = u_light[i].xy;
      float d = distance(l.xy, vec2(col, row));
      if (d < u_light[i].z && !is_blocked(l.xy, vec2(col, row), int(u_light[i].z))) {
        bright += min(0.8, 1.0 - (d / u_light[i].z));
      }
    }
  }

  float xOffset = float(col * (tileW));
  float yOffset = float(row * (tileW));

  vec2 instPos = vec2(a_position);
  instPos.x += xOffset + camera.x;
  instPos.y += yOffset + camera.y;

  // convert the position from pixels to 0.0 to 1.0
  vec2 zeroToOne = instPos / u_resolution;

  // convert from 0->1 to 0->2
  vec2 zeroToTwo = zeroToOne * 2.0;

  // convert from 0->2 to -1->+1 (clipspace)
  vec2 clipSpace = zeroToTwo - 1.0;

  gl_Position = vec4(clipSpace, 0, 1);

  vec2 tile = texelFetch(u_data, ivec2(col, row), 0).rg;

  b_type = tile.r;
  durability = tile.g;
  v_texcoord = a_texcoord;
  atlas_w = u_atlas_w;
}

`,en=`#version 300 es

precision highp float;

// Passed in from the vertex shader.
in vec2 v_texcoord;

in float b_type;
in float durability;
in float atlas_w;
in float bright;

// The texture.
uniform sampler2D u_texture;

// we need to declare an output for the fragment shader
out vec4 outColor;

void main() {
  vec2 tcoord = vec2(v_texcoord.x + (atlas_w * b_type), v_texcoord.y);
  outColor = texture(u_texture, tcoord) * vec4(1.0, durability, durability, 1.0);
  outColor = outColor * vec4(bright, bright, bright, 1.0);
}`,tn=`#version 300 es

// an attribute is an input (in) to a vertex shader.
// It will receive data from a buffer

in vec2 a_position;
in vec2 a_texcoord;

uniform vec2 camera;
uniform vec2 u_movement;
uniform vec2 u_rotation;
uniform float tileW;
uniform int u_selected;

// Used to pass in the resolution of the canvas
uniform vec2 u_resolution;

out vec2 v_texcoord;
out float b_type;
out float is_selected;

// all shaders have a main function
void main() {

  // 10.0 is half of tileW, because we need to offset for rotation to center of tile
  vec2 p = a_position;
  float tW = float(tileW);
  p.x -= tW;
  p.y -= tW;

  vec2 rotated = vec2(
    p.x * u_rotation.y +
        p.y * u_rotation.x,
    p.y * u_rotation.y -
        p.x * u_rotation.x
  );

  rotated += tW;
  rotated += tW;

  rotated += camera + u_movement;

  // convert the position from pixels to 0.0 to 1.0
  vec2 zeroToOne = rotated / u_resolution;

  // convert from 0->1 to 0->2
  vec2 zeroToTwo = zeroToOne * 2.0;

  // convert from 0->2 to -1->+1 (clipspace)
  vec2 clipSpace = zeroToTwo - 1.0;

  gl_Position = vec4(clipSpace, 0, 1);

  v_texcoord = a_texcoord;
  is_selected = float(u_selected);
}
`,nn=`#version 300 es

precision highp float;

// Passed in from the vertex shader.
in vec2 v_texcoord;
in float is_selected;

// The texture.
uniform sampler2D u_texture;

// we need to declare an output for the fragment shader
out vec4 outColor;

void main() {
  vec4 color = texture(u_texture, v_texcoord);
  outColor = vec4(
    color.r,
    color.g,
    // make hidden pixels a transparent blue colour
    color.b + ((1.0 - color.a) * (0.5 * is_selected)),
    color.a + (0.25 * is_selected)
  );
}`,nt=""+new URL("atlas-DZRTRS7K.png",import.meta.url).href;class on{indices;positions;binds;program;vao;vbo;posBuf;atlas;constructor(){this.indices=new Uint16Array([0,1,2,2,3,1]),this.positions=new Float32Array([0,0,P*2,0,0,b,P*3,0,b,0,P*2,1,b,b,P*3,1])}async initGraphics(n){const e=Je(n,[tn,nn]);if(!e)throw new Error("No program");this.program=e;const r={position:n.getAttribLocation(e,"a_position"),move:n.getUniformLocation(e,"u_movement"),tileW:n.getUniformLocation(e,"tileW"),atlas:n.getAttribLocation(e,"a_texcoord"),camera:n.getUniformLocation(e,"camera"),resolution:n.getUniformLocation(e,"u_resolution"),rotation:n.getUniformLocation(e,"u_rotation"),isSelected:n.getUniformLocation(e,"u_selected")};if(r.camera===null||r.position===null||r.resolution===null||r.move===null||r.atlas===null)throw new Error("Bad binds");if(this.binds=r,this.posBuf=n.createBuffer()??void 0,!this.posBuf)throw new Error("No Pos Buf");if(n.bindBuffer(n.ARRAY_BUFFER,this.posBuf),n.bufferData(n.ARRAY_BUFFER,this.positions,n.STATIC_DRAW),this.vao=n.createVertexArray()??void 0,!this.vao)throw new Error("No VAO");n.bindVertexArray(this.vao);const a=2,c=n.FLOAT,l=!1,p=4*Float32Array.BYTES_PER_ELEMENT;let h=0;if(n.vertexAttribPointer(this.binds.position,a,c,l,p,h),n.enableVertexAttribArray(this.binds.position),h+=2*Float32Array.BYTES_PER_ELEMENT,n.vertexAttribPointer(this.binds.atlas,a,c,l,p,h),n.enableVertexAttribArray(this.binds.atlas),this.vbo=n.createBuffer()??void 0,!this.vbo)throw new Error("No VBO");n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,this.vbo),n.bufferData(n.ELEMENT_ARRAY_BUFFER,this.indices,n.STATIC_DRAW),this.atlas=await tt(n,nt),n.bindTexture(n.TEXTURE_2D,null),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),n.bindBuffer(n.ARRAY_BUFFER,null),n.bindVertexArray(null)}render(n,e,r){!this.binds||!this.program||!this.vao||!this.vbo||!this.posBuf||!this.atlas||(et(n.canvas),n.useProgram(this.program),n.bindVertexArray(this.vao),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,this.vbo),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,this.atlas),n.uniform1i(n.getUniformLocation(this.program,"u_texture"),0),n.uniform2fv(this.binds.camera,[-r[0],-r[1]]),n.uniform2fv(this.binds.move,e.coords),n.uniform2fv(this.binds.rotation,e.rotation),n.uniform1f(this.binds.tileW,b/2),n.uniform1i(this.binds.isSelected,e.id===u.selectedEntity?2:0),n.uniform2f(this.binds.resolution,...u.resolution(n)),n.drawElements(n.TRIANGLES,6,n.UNSIGNED_SHORT,0))}}const N=.01;class rn{indices;positions;binds;program;vao;vbo;posBuf;blockTex;atlas;constructor(){this.indices=new Uint16Array([0,1,2,2,3,1]),this.positions=new Float32Array([0,0,N,1-N,0,b,N,N,b,0,P-N,1-N,b,b,P-N,N])}async init(n){const e=Je(n,[Jt,en]);if(!e)throw new Error("No program");this.program=e;const r={position:n.getAttribLocation(e,"a_position"),atlas:n.getAttribLocation(e,"a_texcoord"),tileW:n.getUniformLocation(e,"tileW"),tileX:n.getUniformLocation(e,"tileX"),camera:n.getUniformLocation(e,"camera"),resolution:n.getUniformLocation(e,"u_resolution"),atlasW:n.getUniformLocation(e,"u_atlas_w"),light:n.getUniformLocation(e,"u_light")};if(r.camera===null||r.position===null||r.resolution===null||r.tileW===null||r.tileX===null||r.atlas===null)throw new Error("Bad binds");if(this.binds=r,this.posBuf=n.createBuffer()??void 0,!this.posBuf)throw new Error("No Pos Buf");if(n.bindBuffer(n.ARRAY_BUFFER,this.posBuf),n.bufferData(n.ARRAY_BUFFER,this.positions,n.STATIC_DRAW),this.vao=n.createVertexArray()??void 0,!this.vao)throw new Error("No VAO");n.bindVertexArray(this.vao);const a=2,c=n.FLOAT,l=!1,p=4*Float32Array.BYTES_PER_ELEMENT;let h=0;if(n.vertexAttribPointer(this.binds.position,a,c,l,p,h),n.enableVertexAttribArray(this.binds.position),h+=2*Float32Array.BYTES_PER_ELEMENT,n.vertexAttribPointer(this.binds.atlas,a,c,l,p,h),n.enableVertexAttribArray(this.binds.atlas),this.vbo=n.createBuffer()??void 0,!this.vbo)throw new Error("No VBO");if(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,this.vbo),n.bufferData(n.ELEMENT_ARRAY_BUFFER,this.indices,n.STATIC_DRAW),this.atlas=await tt(n,nt),this.blockTex=n.createTexture()??void 0,!this.blockTex)throw new Error("No block texture");n.bindTexture(n.TEXTURE_2D,this.blockTex);const y=Z();n.pixelStorei(n.UNPACK_ALIGNMENT,1),n.texImage2D(n.TEXTURE_2D,0,n.RGB32F,g,g,0,n.RGB,n.FLOAT,y),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST),n.bindTexture(n.TEXTURE_2D,null),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),n.bindBuffer(n.ARRAY_BUFFER,null),n.bindVertexArray(null)}update(n,e){e?.length&&this.blockTex&&(n.bindTexture(n.TEXTURE_2D,this.blockTex),e.forEach(r=>{const a=new Float32Array([r.type,r.durability,be[r.tile]?0:1]);n.texSubImage2D(n.TEXTURE_2D,0,r.coord[0],r.coord[1],1,1,n.RGB,n.FLOAT,a)}),n.bindTexture(n.TEXTURE_2D,null))}render(n,e){!this.binds||!this.program||!this.vao||!this.blockTex||!this.vbo||!this.posBuf||!this.atlas||(n.useProgram(this.program),n.bindVertexArray(this.vao),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,this.vbo),n.uniform1i(this.binds.tileW,b),n.uniform1i(this.binds.tileX,g),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,this.blockTex),n.activeTexture(n.TEXTURE1),n.bindTexture(n.TEXTURE_2D,this.atlas),n.uniform1i(n.getUniformLocation(this.program,"u_data"),0),n.uniform1i(n.getUniformLocation(this.program,"u_texture"),1),n.uniform1f(this.binds.atlasW,P),n.uniform3fv(this.binds.light,u.lights),n.uniform2fv(this.binds.camera,[-e[0],-e[1]]),n.uniform2f(this.binds.resolution,...u.resolution(n)),n.drawElementsInstanced(n.TRIANGLES,this.indices.length,n.UNSIGNED_SHORT,0,g*g))}}let ee=0;const De=100,Ne=document.getElementById("status"),an=o=>{if(ee>De&&(ee=0),ee++,ee===De&&Ne){const e=u.selectedEntity!==void 0&&u.entities.find(r=>r.id===u.selectedEntity);Ne.textContent=e?cn(e):""}const n=u.actions.getActions();u.runScripts();for(let e of u.entities){const r=n.find(a=>a.entityId===e.id);e.update(r)}u.world?.update(o,u.actions.getMapUpdates())},sn=async o=>{We(),u.world=new rn,u.gl=o;const n=new on;await n.initGraphics(o),u.entityGfx=n,u.camera=[(g/2-11.5)*b,(g/2-7)*b],To(),await u.world.init(o),u.updateLights()},ke=$e/2,Be=Ge/2,X=o=>{const n=u.camera,e=[n[0]+ke,n[1]+Be],r=o[0]-e[0],a=o[1]-e[1],c=Math.sign(r),l=Math.sign(a),p=Math.abs(r),h=Math.abs(a);return[p/ke*c,h/Be*l]},cn=o=>{const n=u.actions.getActions().find(e=>e.entityId===o.id&&!e.isComplete&&!e.isCancelled);return`
Entity:    ${o.name}
Battery:   ${o.battery} / ${o.maxBattery}
Inventory: ${o.inventory.total} / ${o.inventorySize}
${n?`${n?.type}${n?.value!==void 0?` - ${n.value}`:""}`:" - IDLE - "}
`};let ge=!1;const ln=async o=>{const n=1e3/pt;let e=Date.now();for(;ge;){let r=e+n;Date.now()<r&&await new Promise(a=>setTimeout(a,10)),an(o),await new Promise(a=>requestAnimationFrame(()=>{et(o.canvas),o.viewport(0,0,o.canvas.width,o.canvas.height),o.clearColor(.1,.1,.1,1),o.enable(o.BLEND),o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT),u.world?.render(o,u.camera);for(let c of u.entities)c.render(o,u.camera);a()})),e=Date.now()}},dn=()=>{const o=document.createElement("canvas");return o.id="c",o.width=$e,o.height=Ge,o.style.backgroundColor="#000",o.style.transition="height 10ms ease-out",document.querySelector("div.container > div.canvas-container")?.prepend(o),new Promise(n=>{setTimeout(()=>{o.style.height="600px",o.addEventListener("transitionend",async()=>{const e=o.getContext("webgl2",{premultipliedAlpha:!1});o.style.border="none",e&&(ge=!0,await sn(e),n(void 0),e.getExtension("EXT_color_buffer_float"),ln(e))},{once:!0})},1e3)})},un=()=>(document.getElementById("c")?.remove(),ge=!1,new Promise(o=>setTimeout(o,500))),fn=`
  <div id="interface_control" class="flex-row">
    <div></div>
    <div>
        <div class="flex-col gap justified items-center">
            <div class="flex-row gap">
                <div class="flex-row gap border">
                    <button>&#9651;</button>
                    <button>&#10699;</button>
                </div>
                <div class="flex-row gap justified border">
                    <button>&#9665;</button>
                    <button>&#9655;</button>
                </div>
            </div>
            <div class="flex-row gap justify-center border items-center flex-wrap">
                <button>Mine</button>
                <button>Mine x 5</button>
                <button>Unload</button>
                <button>Recharge</button>
                <button>Focus</button>
            </div>
        </div>
    </div>
    <div></div>
  </div>
`,_n=()=>{const o=document.getElementById("nav"),n=document.getElementById("context"),e=document.createElement("div");e.textContent="Control";const r=document.createElement("div");if(r.id="control_control",r.classList.add("hidden"),r.innerHTML=fn,e.addEventListener("click",()=>ut(e,"control_control")),o?.appendChild(e),n?.appendChild(r),pn(r),hn(),u.selectedEntity!==void 0){const a=u.actions.getActions().filter(c=>c.entityId===u.selectedEntity&&!c.isSilent);Fe(a)}u.actions.hook.addEventListener(Xe,a=>{const c=a;c.detail.entityId===u.selectedEntity&&ot(c.detail)}),u.actions.hook.addEventListener(Te,a=>{const c=a;c.detail.entityId===u.selectedEntity&&mn(c.detail)}),u.entityHook.addEventListener(dt,a=>{const c=a;Array.from(document.querySelectorAll("#interface_control > div:first-child > div")).forEach(h=>h.classList.remove("active")),document.querySelector(`#interface_control > div:first-child > div[data-id="${c.detail}"]`)?.classList.add("active");const p=u.actions.getActions().filter(h=>h.entityId===u.selectedEntity&&!h.isSilent);Fe(p)})},Fe=o=>{const n=document.querySelector("#interface_control > div:last-child");if(n){n.innerHTML="";for(let e of o)ot(e,n)}},ot=(o,n)=>{n=n??document.querySelector("#interface_control > div:last-child")??void 0;const e=document.createElement("div");e.textContent=`${o.type} - ${o.value}`,e.dataset.id=o.id,n?.appendChild(e)},mn=o=>{const n=document.querySelector("#interface_control > div:last-child")??void 0;n&&n.querySelector(`div[data-id="${o.id}"]`)?.remove()},pn=o=>{const[n,e,r,a,c,l,p,h,y]=Array.from(o.querySelectorAll("button"));e.addEventListener("click",()=>{if(u.selectedEntity!==void 0){u.actions.addAction("MOVE",{value:5,entityId:u.selectedEntity});for(let E=1;E<5;E++)u.actions.addSilentAction("MOVE",{value:1,entityId:u.selectedEntity})}}),n.addEventListener("click",()=>{u.selectedEntity!==void 0&&u.actions.addAction("MOVE",{value:1,entityId:u.selectedEntity})}),r.addEventListener("click",()=>{u.selectedEntity!==void 0&&u.actions.addAction("ROTATE",{value:-1,entityId:u.selectedEntity})}),a.addEventListener("click",()=>{u.selectedEntity!==void 0&&u.actions.addAction("ROTATE",{value:1,entityId:u.selectedEntity})}),c.addEventListener("click",()=>{u.selectedEntity!==void 0&&u.actions.addAction("DEVICE",{value:0,entityId:u.selectedEntity})}),l.addEventListener("click",()=>{if(u.selectedEntity!==void 0){u.actions.addAction("DEVICE",{value:5,entityId:u.selectedEntity});for(let E=1;E<5;E++)u.actions.addSilentAction("DEVICE",{value:1,entityId:u.selectedEntity})}}),p.addEventListener("click",()=>{u.selectedEntity!==void 0&&u.actions.addAction("UNLOAD",{value:0,entityId:u.selectedEntity})}),h.addEventListener("click",()=>{u.selectedEntity!==void 0&&u.actions.addAction("RECHARGE",{value:100,entityId:u.selectedEntity})}),y.addEventListener("click",()=>{u.selectedEntity!==void 0&&u.focusEntity(u.selectedEntity)})},hn=()=>{const o=document.querySelector("#interface_control > div:first-child")??void 0;o&&u.entities.forEach(n=>{const e=document.createElement("div");e.dataset.id=n.id.toString(),e.textContent=`[${n.id}] ${n.name}`,o.appendChild(e),e.addEventListener("click",()=>u.selectEntity(n.id))})},I={stone:{name:"stone",type:"RESOURCE",description:"",label:"Stone"},iron:{name:"iron",type:"RESOURCE",description:"",label:"Iron Ore"},carbon:{name:"carbon",type:"RESOURCE",description:"",label:"Carbon"},copper:{name:"copper",type:"RESOURCE",description:"",label:"Copper Ore"},coal:{name:"coal",type:"RESOURCE",description:"",label:"Coal"},interface_control:{name:"interface_control",ingredients:[{item:"stone",count:50},{item:"iron",count:10}],story:["IRON_FIRST"],description:"Extra control interface for manual remote instruction",type:"INTERFACE",waypoint:"INTERFACE_CONTROL_INTERFACE",label:"Control Interface"},interface_automation:{name:"interface_automation",ingredients:[{item:"stone",count:50},{item:"iron",count:10},{item:"copper",count:10},{item:"carbon",count:10}],story:["IRON_FIRST","CARBON_FIRST","COPPER_FIRST"],description:"Allow automated remote instruction",type:"INTERFACE",waypoint:"INTERFACE_AUTOMATION_INTERFACE",label:"Automation Interface"},interface_smelting:{name:"interface_smelting",ingredients:[{item:"iron",count:50},{item:"stone",count:200}],story:["IRON_FIRST"],description:"For the production of alloy metals",type:"INTERFACE",waypoint:"INTERFACE_SMELTING",label:"Smelting Interface"},module_visual_scanner:{name:"module_visual_scanner",ingredients:[{item:"iron",count:10}],story:["IRON_FIRST"],description:"Visually assess one tile in front",type:"MODULE",label:"Visual Scanner (Module)",quality:"BASIC",moduleType:"navigation",deviceType:"visual_scanner",stats:{}},module_basic_battery:{name:"module_basic_battery",ingredients:[{item:"stone",count:20},{item:"iron",count:10}],story:["IRON_FIRST"],description:"A very simple battery with limited capacity",type:"MODULE",label:"Basic Battery (Module)",quality:"BASIC",moduleType:"battery",stats:{battery:100,rechargeSpeed:1},actionType:["RECHARGE"]},module_basic_drill:{name:"module_basic_drill",ingredients:[{item:"iron",count:30}],story:["IRON_FIRST"],description:"A brittle, dull drill",type:"MODULE",label:"Basic Drill (Module)",quality:"BASIC",moduleType:"device",deviceType:"drill",stats:{drillSpeed:1,drillPower:1},actionType:["DEVICE"]},module_basic_motor:{name:"module_basic_motor",ingredients:[{item:"stone",count:20},{item:"iron",count:50}],story:["IRON_FIRST"],description:"5hp of pure disappointment",type:"MODULE",label:"Basic Motor (Module)",quality:"BASIC",moduleType:"engine",stats:{speed:1},actionType:["MOVE","ROTATE"]},module_basic_store:{name:"module_basic_store",ingredients:[{item:"stone",count:20},{item:"iron",count:20}],story:["IRON_FIRST"],description:"10 slot store",type:"MODULE",label:"Basic Store",quality:"BASIC",moduleType:"store",stats:{inventorySize:10},actionType:["UNLOAD"]},module_home_navigation:{name:"module_home_navigation",ingredients:[{item:"carbon",count:10},{item:"copper",count:10}],story:["CARBON_FIRST","COPPER_FIRST"],description:"Provides automated routing to nearest base",type:"MODULE",label:"Home Navigation (Module)",quality:"BASIC",moduleType:"navigation",stats:{}},module_dev:{name:"module_dev",type:"MODULE",label:"DEV DEV DEV",quality:"BASIC",description:"DEV DEV DEV",moduleType:"engine",stats:{battery:1e4,drillSpeed:10,speed:10,inventorySize:1e4,rechargeSpeed:10,drillPower:10},ingredients:[],actionType:["ROTATE","MOVE","DEVICE","UNLOAD","RECHARGE"],deviceType:"drill"},module_dev_drill:{name:"module_dev_drill",type:"MODULE",label:"DEV DEV DEV",quality:"BASIC",description:"DEV DEV DEV",moduleType:"device",ingredients:[],actionType:["DEVICE"],stats:{},deviceType:"drill"},deployable_automation_hull:{name:"deployable_automation_hull",ingredients:[{item:"iron",count:10}],story:["IRON_FIRST"],description:"An empty mining automation hull (deployable)",type:"DEPLOYABLE",label:"Basic Automation Hull",quality:"BASIC"}},yn=(o,n)=>{n<0||(u.story.STORAGE_FIRST||u.addWaypoint("STORAGE_FIRST"),o==="iron"&&!u.story.IRON_FIRST&&u.addWaypoint("IRON_FIRST"),o==="carbon"&&!u.story.CARBON_FIRST&&u.addWaypoint("CARBON_FIRST"),o==="copper"&&!u.story.COPPER_FIRST&&u.addWaypoint("COPPER_FIRST"))},vn=(o,n)=>{if(u.story.DEPLOY_FIRST||(u.addWaypoint("DEPLOY_FIRST"),D(`An automation requires modules in order to be useful.
Useful commands: list, select, equip`)),u.entityGfx){const e=u.entities.length;n=n||`ENTITY-${e}`,u.entities.push(new ce(u.entityGfx,u.entities.length,n,[],[])),u.updateLights()}},En=o=>{const n=I[o];if(!n||!n.ingredients)return!1;const e=n.ingredients;for(let r of e)if((u.inventory.inventory[r.item]??0)<r.count)return!1;for(let r of e)u.inventory.remove(r.item,r.count);return n.type==="MODULE"||n.type==="DEPLOYABLE"?u.inventory.add(o):n.type==="INTERFACE"&&u.addWaypoint(n.waypoint),!0},bn=o=>{switch(o){case"STORAGE_FIRST":D(`Crafting Unlocked
see command "crafting" for more information`);break;case"IRON_FIRST":D("New recipes available");break;case"CARBON_FIRST":u.story.COPPER_FIRST&&D("New recipes available");break;case"COPPER_FIRST":u.story.CARBON_FIRST&&D("New recipes available");break;case"INTERFACE_CONTROL_INTERFACE":D("Control interface installed"),Pe();break;case"INTERFACE_AUTOMATION_INTERFACE":D("Automation interface installed"),Pe();break}},Pe=()=>{_n()},rt=async()=>{D("Welcome..."),await G(),A("Initialising environment..."),await G(),U("INIT CONNECTION..."),await G(),U("INIT CAMERA..."),await G(),await dn(),await G(),U("INIT COMPLETE"),await G(),le(),D(`Your first task will be to deploy and construct a mining automation
========
Type "help" to get started
Useful commands: storage, deploy`);const o=[];if([["deployable_automation_hull",1],["module_basic_drill",1],["module_basic_motor",1],["module_basic_store",1],["module_basic_battery",1]].forEach(([e,r])=>u.inventory.add(e,r)),o.forEach(e=>u.addWaypoint(e)),u.saveScript(new we("test",`
        START:
            RUN move 3
            RUN mine 10
            RUN rotate 2
            RUN move 3
            RUN unload
            RUN rotate 2
            RUN recharge
    `)),u.entityGfx){const e=new ce(u.entityGfx,0,"twat",[],["module_basic_drill","module_basic_motor","module_basic_store","module_basic_battery","module_visual_scanner"]);e.init(),u.entities.push(e),u.updateLights()}u.inventory.hook=yn,u.onStory=bn,u.onDeploy=vn},G=o=>{},Tn=2,An=2200,wn=2e3,gn=function(o){const e=this.modules.filter(a=>I[a].moduleType==="device").at(o.value);switch(e?I[e].deviceType:void 0){case"drill":return Sn.call(this,o);case"visual_scanner":return xn.call(this,o);default:R(`Entity [${this.id}] - Unknown device [${o.value}]`),o.complete();return}},Sn=function(o){if(o.isStarted?o.moveSound(X(this.coords)):(o.timeEnd=Date.now()+(An-this.drillSpeed*200),o.addSound("drill",X(this.coords)),o.start()),o.timeEnd>Date.now())return;o.complete();const n=Se(k(this.coords),this.angle,1);if(n.type===x.ROCK||n.type===x.ORE){let e=n.durability*Ce[n.tile];e-=this.drillPower;const r=Tt(n);for(let a=0;a<this.drillPower;a++){const c=vt[n.tile]??[];for(let l of c){let p=l.chance?l.chance:(l.baseChance??0)*(r*.2);for(;p>0;)Math.random()<=p&&this.inventory.add(l.item),p-=1}}if(e<=0){const a=bt(n.coord);u.actions.addMapUpdate({...n,type:x.FLOOR,durability:1,tile:"FLOOR"});for(let c of a)if(c.type===x.SHADOW){let l=x.ROCK,p="ROCK";Math.random()<.01*r&&(l=x.ORE,p="ORE"),u.actions.addMapUpdate({...c,type:l,durability:1,tile:p})}}else u.actions.addMapUpdate({...n,durability:e/Ce[n.tile]})}},xn=function(o){if(o.isStarted||(o.timeEnd=Date.now()+wn,o.start()),o.timeEnd>Date.now())return;const n=Se(k(this.coords),this.angle,1);o.complete(n.type)},Se=(o,n,e=1)=>{const r=[...o];return n===0?r[0]+=e:n===1?r[1]-=e:n===2?r[0]-=e:n===3&&(r[1]+=e),C(r)},In=Object.freeze(Object.defineProperty({__proto__:null,BATTERY_COST:Tn,command:gn,getFacingTile:Se},Symbol.toStringTag,{value:"Module"})),ye=(o,n,e)=>Math.max(o,Math.min(n,e)),Rn=1,On=b/100,Cn=function(o){if(o.isStarted)o.moveSound(X(this.coords));else{o.addSound("track_move",X(this.coords));const a=Ln(1,this.angle,this.coords);this.angle===3&&(this.target=[this.coords[0],this.coords[1]+a*b]),this.angle===0&&(this.target=[this.coords[0]+a*b,this.coords[1]]),this.angle===1&&(this.target=[this.coords[0],this.coords[1]-a*b]),this.angle===2&&(this.target=[this.coords[0]-a*b,this.coords[1]]),o?.start()}const n=this.speed*On;let e;this.target&&(e=[ye(-n,n,this.target[0]-this.coords[0]),ye(-n,n,this.target[1]-this.coords[1])]),e?.[0]===0&&e?.[1]===0&&(u.updateLights(),o?.complete(),this.target=void 0,e=void 0),e&&(u.isFollowing===this.id&&(u.camera[0]+=e[0],u.camera[1]+=e[1]),this.coords=[this.coords[0]+e[0],this.coords[1]+e[1]])},Ln=(o,n,e)=>{let r=[0,0];n===ue.DOWN?r=[0,-b]:n===ue.LEFT?r=[-b,0]:n===ue.RIGHT?r=[b,0]:r=[0,b];let a=0,c=[...e];for(;a<o;){c[0]+=r[0],c[1]+=r[1];const l=k(c),p=C(l);if(!be[p.tile])break;a++}return a},Mn=Object.freeze(Object.defineProperty({__proto__:null,BATTERY_COST:Rn,command:Cn},Symbol.toStringTag,{value:"Module"})),Dn=1,Nn=function(o){let n=this.targetR;if(o.isStarted?o.moveSound(X(this.coords)):(o.addSound("track_move",X(this.coords)),n=this.angle+(o.value>0?1:-1),n<0&&(n=4+n),n>3&&(n=n-4),o.start()),n===void 0){o.complete();return}this.targetR=n;const e=pe[this.targetR];let r=0;if(o.value<0){let a=this.rad<e?this.rad+Oe:this.rad;r=-.05,a+r<=e&&o.complete()}else{let a=this.rad>e?this.rad-Oe:this.rad;r=.05,a+r>=e&&o.complete()}o.isComplete?(this.rad=pe[this.targetR],this.angle=this.targetR,this.targetR=void 0):this.rad+=r,this.rotation[0]=Math.sin(this.rad),this.rotation[1]=Math.cos(this.rad)},kn=Object.freeze(Object.defineProperty({__proto__:null,BATTERY_COST:Dn,command:Nn},Symbol.toStringTag,{value:"Module"})),Bn=0,Fn=function(o){o.complete();const n=k(this.coords);C(n).type===x.HOME?(Object.entries(this.inventory.inventory).forEach(([r,a])=>{u.inventory.add(r,a),this.inventory.remove(r,a)}),He(this.id,"Unloading")):He(this.id,"Unable to unload")},Pn=Object.freeze(Object.defineProperty({__proto__:null,BATTERY_COST:Bn,command:Fn},Symbol.toStringTag,{value:"Module"})),Un=0,Ue=550,Hn=function(o){if(!o.isStarted){const e=k(this.coords);if(C(e).type!==x.HOME){R(`Entity [${this.id}] - Unable to recharge at this location`),o.complete();return}o.timeEnd=Date.now()+(Ue-this.rechargeSpeed*50),o.start()}if(o.timeEnd>Date.now())return;const n=o.value?Math.max(0,Math.min(100,o.value))/100*this.maxBattery:this.maxBattery;if(this.battery>=n||o.shouldCancel){o.complete();return}this.battery++,o.timeEnd=Date.now()+(Ue-this.rechargeSpeed*100)},Vn=Object.freeze(Object.defineProperty({__proto__:null,BATTERY_COST:Un,command:Hn},Symbol.toStringTag,{value:"Module"})),$n=function(o){if(!this.actions.includes(o.type)){o.complete();return}let n;switch(o.type){case"MOVE":n=Mn;break;case"ROTATE":n=kn;break;case"DEVICE":n=In;break;case"UNLOAD":n=Pn;break;case"RECHARGE":n=Vn;break}if(n){if(!o.isStarted){if(n.BATTERY_COST){if(this.battery<n.BATTERY_COST){o.cancel();return}this.battery=Math.max(0,this.battery-n.BATTERY_COST)}Yn(this,o)}return n.command.call(this,o)}};class ie{inventory={};limit;total;hook;constructor(n,e){this.hook=n,this.limit=e,this.total=0}add(n,e=1){this.limit&&(e=Math.max(0,Math.min(this.limit-this.total,e))),e&&(this.total+=e,this.inventory[n]=(this.inventory[n]??0)+e,this.hook?.(n,e))}remove(n,e=1){return(this.inventory[n]??0)>=e?(this.inventory[n]=this.inventory[n]-e,this.total-=e,this.hook?.(n,-e),this.inventory[n]||delete this.inventory[n],!0):!1}}class ce{id;name;gfx;actions;rotation=[0,1];rad=pe[3];angle=3;inventorySize;inventory;speed;drillSpeed;battery;maxBattery;rechargeSpeed;drillPower;deviceSlots=1;target;targetR;coords;modules;getSave(){return{...this,inventory:this.inventory.inventory,gfx:void 0}}constructor(n,e,r,a=["MOVE","ROTATE"],c){this.gfx=n,this.id=e,this.coords=[Math.round(g/2*b)-b/2,Math.round(g/2*b)-b/2],this.rotation[0]=Math.sin(this.rad),this.rotation[1]=Math.cos(this.rad),this.actions=a,this.name=r,this.maxBattery=0,this.battery=this.maxBattery,this.speed=0,this.drillSpeed=0,this.inventorySize=0,this.rechargeSpeed=0,this.drillPower=0,this.inventory=new ie(void 0,this.inventorySize),this.modules=c??[]}async init(){this.balanceModules(),this.battery=this.maxBattery}installModule(n){const e=I[n];if(!e)return!1;const r=this.modules.filter(a=>I[a].moduleType===e.moduleType);return e.moduleType==="device"&&r.length>=this.deviceSlots||r.length?!1:(this.modules.push(n),this.balanceModules(),!0)}uninstallModule(n){return this.modules.includes(n)?(this.modules=this.modules.filter(e=>e!==n),this.balanceModules(),!0):!1}balanceModules(){this.speed=0,this.drillSpeed=0,this.rechargeSpeed=0,this.drillPower=0,this.maxBattery=0,this.inventorySize=0,this.actions=[],this.modules.forEach(n=>{const e=I[n],r=e.stats;this.speed+=r?.speed??0,this.maxBattery+=r?.battery??0,this.drillSpeed+=r?.drillSpeed??0,this.inventorySize+=r?.inventorySize??0,this.rechargeSpeed+=r?.rechargeSpeed??0,this.drillPower+=r?.drillPower??0,this.actions.push(...e.actionType??[])}),this.inventory.limit=this.inventorySize}update(n){const e=this.battery;n&&$n.call(this,n),this.battery!==e&&(this.battery<=0?R(`Entity ${this.id} - no power, battery empty`):this.battery<=this.maxBattery*.2&&e>this.maxBattery*.2?U(`Entity ${this.id} - battery low warning`):this.battery<=this.maxBattery*.1&&e>this.maxBattery*.1&&R(`Entity ${this.id} - battery is critical`))}render(n,e){this.gfx.render(n,this,e)}}const Y=document.querySelector("#control_console div#output"),ve={Manage:[["list","List available entities.",""],["storage","Show current store inventory.",""],["deploy","Deploy from storage. Ex. deploy <deployable_name> <label>.","str, str?"],["select","Select entity for control.","int"],["selected","Show currently selected entitiy.",""],["edit","Edit a script.","str"],["bind","Bind a key to a command Ex. bind <cmd> <args?>","str"]],Entity:[["commands","List available commands for selected entity.",""],["inventory","Show current entity inventory.",""],["battery","Show current entity battery value.",""],["modules","List currently installed modules and stats.",""],["devices","List currently installed devices.",""],["exec","Execute a named script.",""],["install","Install a module from the main storage.","str"],["uninstall","Remove an installed module.","str"],["actions","Display queue of actions.",""],["focus","Move camera and follow selected entity.",""],["cancel","Cancel current action where possible.",""],["halt","Cancel all queued actions where possible.",""]]},Gn={DEVICE:["device","Activate device <n>","int=0"],MOVE:["move","Move <n> in facing direction.","int=1"],RECHARGE:["recharge","Recharge entity battery <n> units. HOME ONLY.","int?"],ROTATE:["rotate","Rotate 90 degrees CW <n> or CCW <-n>.","int [-3, 3]"],UNLOAD:["unload","Move entity inventory to storage. HOME ONLY.",""]},Wn=ve.Entity.map(o=>o.at(0)),A=(o,n)=>{const e=o.split(`
`).map(c=>{const l=document.createElement("p");return l.textContent=c||"",n&&(l.className=n),l}),r=Array.from(Y?.children??[]),a=r.length+e.length-yt;for(let c=0;c<Math.max(a,0);c++)r[c]?.remove();e.forEach(c=>Y?.appendChild(c)),Y?.scrollTo(0,Y.scrollHeight??0)},D=o=>{A(o,"important")},U=o=>{A(`[WARNING] ${o}`,"warning")},O=(o,n=!0)=>{A(o,n?"bold header white":"header black")},R=o=>{A(`[ERROR] ${o}`,"error")},Yn=(o,n)=>{!n||n.isSilent||A(`[${(Date.now()/1e3).toFixed(0)}] Entity [${o.id}] - ${n.type}: ${n.value}`,"log")},He=(o,n)=>{A(`[ENTITY:${o}] ${n}`)},H=(o,n,e=" ")=>{const r=[...n?[n]:[],...o].reduce((a,c)=>(c.forEach((l,p)=>{a[p]=Math.max(a[p]??0,l.length)}),a),[]);n&&O(n.map((a,c)=>a.padEnd(r[c]??0)).join(e),!1),o.forEach(a=>{A(a.map((c,l)=>c.padEnd(r[l]??0)).join(e))})},Ve=o=>{A(" "),A(` > ${o}`);const[n,...e]=o.split(" "),r=n.toLowerCase(),a=Xn(r,e);if(a===!1){R("Invalid argument");return}else if(a)return;const c=it(u.selectedEntity,r,e);if(c===void 0){R("No entity selected!");return}else if(c?.length)return;R(`Unknown command: ${r}`)},it=(o,n,e)=>{const r=o!==void 0?u.entities.find(l=>l.id===o):void 0;if(!r)return;const[a]=e,c=l=>{const p=parseInt(a??0);let h=[];const y=u.actions.addAction(l,{entityId:r.id,timeEnd:Date.now()+1e5,value:p});if(l==="MOVE"||l==="ROTATE"||l==="DEVICE")for(let E=1;E<Math.abs(y.value??p);E++){const t=u.actions.addSilentAction(l,{entityId:r.id,timeEnd:Date.now()+1e5,value:p},y.id);h.push(t)}return y.addChildren(h),[y,...h].map(E=>E.id)};return r.actions.includes(n.toUpperCase())?c(n.toUpperCase()):[]},Xn=(o,n)=>{const[e]=n;switch(o){case"help":return jn(),!0;case"list":return qn(),!0;case"select":return at(parseInt(e));case"storage":return Qn(),!0;case"deploy":return zn(n);case"clear":return le(),!0;case"crafting":return lo(e);case"selected":return Zn(),!0;case"dev_spawn":return co();case"save":return ct(),!0;case"load":return _o(),!0;case"reset":return fo(),!0;case"edit":return po(e),!0;case"bind":return ho(n),!0}if(Wn.includes(o)){const r=u.selectedEntity!==void 0?u.entities.find(a=>a.id===u.selectedEntity):void 0;if(r)switch(o){case"commands":return Kn(r),!0;case"inventory":return eo(r),!0;case"battery":return to(r),!0;case"cancel":return ro(r),!0;case"halt":return io(r),!0;case"focus":return Jn(r),!0;case"modules":return no(r),!0;case"devices":return oo(r),!0;case"actions":return mo(r),!0;case"exec":return uo(r,e);case"install":return ao(r,e);case"uninstall":return so(r,e)}else return R("No entity selected."),!0}},at=o=>isNaN(o)||!u.entities.find(e=>e.id===o)?!1:(u.selectEntity(o),A(`Entity ${o} selected`),!0),qn=()=>{O("Entities"),A(u.entities.map(o=>`[${o.id}] - ${o.name}`).join(`
`))},jn=()=>{u.story.STORAGE_FIRST,O("Help"),A(` - Manage -
`),H(ve.Manage,["Command","Description","Args"]," | "),A(`
- Entity -
`),H(ve.Entity,["Command","Description","Args"]," | ")},zn=([o,n])=>o&&I[o]?.type==="DEPLOYABLE"?(u.deploy(o,n),!0):(R(`"${o}" is not recognised as a deployable item.`),!0),Zn=()=>{const o=u.selectedEntity!==void 0?u.entities.find(n=>n.id===u.selectedEntity):void 0;O("Selected"),A(o?`[${o.id}] - ${o.name}`:"- NONE -")},Kn=(o,n)=>{O("Commands");const e=o.actions;H(e.map(r=>Gn[r]),["Command","Description","Args"]," | ")},Qn=()=>{O("Storage"),st(Object.entries(u.inventory.inventory).map(([o,n])=>[o,n]))},st=o=>{const n=o.map(([e,r])=>[`[${e}]`,I[e].label,I[e].type,I[e].quality??"",r.toString()]);H(n,["Name","Label","Type","Quality","Quantity"]," | ")},Jn=(o,n)=>{u.focusEntity(o.id)},eo=(o,n)=>{O("Inventory"),A(`Slots: ${o.inventory.total} / ${o.inventory.limit??"-"}`),st(Object.entries(o.inventory.inventory).map(([e,r])=>[e,r]))},to=(o,n)=>{A(`Entity [${o.id}] battery: ${o.battery} / ${o.maxBattery}`)},no=(o,n)=>{O("Installed Modules"),H(o.modules.map(e=>{const r=I[e];return[e,r.label,r.quality,r.moduleType]}),["Name","Label","Quality","Type"]," | "),A(`[ Movement: ${o.speed} ] [ Battery: ${o.battery} / ${o.maxBattery} ] [ Charge Speed: ${o.rechargeSpeed} ]`),A(`[ Drill Power: ${o.drillPower} ] [ Drill Speed: ${o.drillSpeed} ]`)},oo=(o,n)=>{O("Installed Devices");const e=o.modules.map(r=>I[r]).filter(r=>r.moduleType==="device");H(e.map((r,a)=>[`[${a}]`,r.name,r.label,r.quality,r.deviceType??""]),["ID","Name","Label","Quality","Type"]," | ")},ro=(o,n)=>{const e=u.actions.cancelOneForEntity(o.id);e&&A(`Entity [${o.id}] request to cancel ${e.type}`)},io=(o,n)=>{u.actions.cancelAllForEntity(o.id),u.cancelScripts(o.id),A(`Entity [${o.id}] cancel all queued actions`)},ao=(o,n)=>{const e=k(o.coords);return C(e).type!==x.HOME?(R("Unable to install modules here"),!0):!I[n]||!u.inventory.remove(n,1)?(R(`Unknown or module not in storage - "${n}"`),!0):(o.installModule(n)||(R(`Unable to install ${n}, slot already used or incompatible`),u.inventory.add(n,1)),!0)},so=(o,n)=>{const e=k(o.coords);return C(e).type!==x.HOME?(R("Unable to uninstall modules here"),!0):o.uninstallModule(n)?(u.inventory.add(n,1),!0):(R(`No module called "${n}" is installed on this automation`),!0)},co=()=>{if(!u.gl||!u.entityGfx)return;const o=new ce(u.entityGfx,u.entities.length,"DEVBOT",["ROTATE","MOVE","DEVICE","UNLOAD","RECHARGE"],["module_dev"]);return o.init(),u.entities.push(o),u.updateLights(),at(o.id),!0},lo=o=>{if(!u.story.STORAGE_FIRST)return;if(o?.trim())return I[o].ingredients?En(o):(R(`Unknown recipe: ${o}`),!0);const n=Object.entries(I).filter(([,e])=>e.ingredients?.length).filter(([,e])=>(e.story??[]).every(r=>u.story[r])).filter(([,e])=>!e.waypoint||!u.story[e.waypoint]).map(([e])=>{const r=I[e];return[e,r.description,r.ingredients.map(a=>`${a.item}[${a.count}]`).join(",")]});return O("Crafting"),A('Usage: "crafting <recipe>"'),H(n,["Name","Description","Recipe"]," | "),!0},uo=(o,n)=>{if(!u.scripts[n])return R(`Unknown script ${n}`),!0;const e=new Wt(o,u.scripts[n]);return u.executors.push(e),!0},le=()=>{Y&&(Y.innerHTML="")},ct=()=>{window.localStorage.setItem("save",btoa(JSON.stringify(u.getSave()))),U("Game saved.")},fo=async()=>{U("RESETTING GAME"),window.localStorage.setItem("save",""),Qt(),u.reset(),await un(),le(),rt()},_o=()=>{const o=window.localStorage.getItem("save");if(o?.length){const n=JSON.parse(atob(o));Object.keys(n.story??{}).length&&(le(),u.onLoad(n),U("Game loaded."))}},mo=o=>{const n=u.actions.getActions().filter(e=>e.entityId===o.id).filter(e=>!e.isSilent);O("Actions"),n.forEach(e=>{A(` - ${e.type} [${e.value}]`)})},po=o=>{Xt(o)},ho=o=>{Ao(o.join(" "))},yo=10,lt=-3,dt="ENTITY_SELECTED";class vo{gl;entityGfx;world;camera=[0,0];actions;zoom=0;selectedEntity;inventory;isFollowing;entities=[];executors=[];story={};history=[];onStory;onDeploy;scripts;keybinds;lights;entityHook;getSave(){const n={stack:this.actions.stack,mapUpdates:this.actions.mapUpdates,mapChanges:Eo(this.actions.mapChanges)};return{...this,inventory:this.inventory.inventory,gl:void 0,entityGfx:void 0,entities:this.entities.map(e=>e.getSave()),executors:[],lights:[],actions:n}}onLoad(n){Object.assign(this,{camera:n.camera??this.camera,zoom:n.zoom??this.zoom,selectedEntity:n.selectedEntity??this.selectedEntity,isFollowing:n.isFollowing??this.isFollowing,story:n.story??this.story,history:n.history??this.history,scripts:n.scripts??this.scripts}),this.inventory.inventory=n.inventory??this.inventory.inventory,this.entityGfx&&(this.entities=n.entities?.map(e=>{const r=new ce(this.entityGfx,e.id,e.name,e.actions,e.modules);return Object.assign(r,e),r.inventory=new ie,r.inventory.inventory=e.inventory??{},r.balanceModules(),r})??[]),this.actions&&n.actions&&(this.actions.stack=n.actions.stack.map(e=>{const r=new he(e.type,{delta:e.delta,value:e.value,timeEnd:e.timeEnd,entityId:e.entityId},e.isSilent,e.parentId);return r.id=e.id,r.isComplete=e.isComplete,r.isStarted=e.isStarted,r.shouldCancel=e.shouldCancel,r}),this.actions.mapChanges=n.actions.mapChanges),this.inventory&&Object.assign(this.inventory,n.inventory),this.actions.mapChanges.forEach(e=>{Ye(e),this.actions.mapUpdates.push(e)}),this.updateLights()}reset(){At(),this.gl=void 0,this.actions=new Me,this.entities=[],this.inventory=new ie,this.lights=new Float32Array(48).fill(0),this.entityHook=new EventTarget,this.story={},this.scripts={},this.keybinds=[]}constructor(n=new Me,e=new ie,r){this.lights=new Float32Array(48).fill(0),this.actions=n,this.inventory=e,this.onStory=r,this.entityHook=new EventTarget,this.scripts={},this.keybinds=[]}selectEntity(n){this.focusEntity(n)&&(this.selectedEntity=n,this.entityHook.dispatchEvent(new CustomEvent(dt,{detail:n})))}focusEntity(n){const e=this.entities.find(r=>r.id===n);return e?(this.isFollowing=n,this.camera=[e.coords[0]-11*b,e.coords[1]-6.5*b],this.zoom=0,!0):!1}resolution(n){const e=n.canvas.height/n.canvas.width,r=n.canvas.width+100*this.zoom,a=n.canvas.height+100*this.zoom*e;return[r,a]}setZoom(n){const e=ye(lt,yo,n);if(e>this.zoom)this.camera[0]=this.camera[0]-b,this.camera[1]=this.camera[1]-b;else if(e<this.zoom)this.camera[0]=this.camera[0]+b,this.camera[1]=this.camera[1]+b;else return;this.zoom=e}getHistory(){return this.history=this.history.slice(-Ee).toReversed().filter((n,e,r)=>r.indexOf(n)===e).reverse(),this.history}addWaypoint(n){this.story[n]||(this.story[n]=!0,this.onStory?.(n))}updateLights(){const n=new Float32Array(48).fill(0);for(let e=0;e<u.entities.length;e++){const[r,a]=k(u.entities[e].coords);n[e*3]=r,n[e*3+1]=a,n[e*3+2]=5}this.lights=n}deploy(n,e){this.inventory.remove(n)&&this.onDeploy?.(n,e)}runScripts(){for(let n of this.executors)n.run(),n.isComplete&&A("Script finished");this.executors=this.executors.filter(n=>!n.isComplete)}cancelScripts(n){this.executors=this.executors.filter(e=>e.entity.id!==n)}saveScript(n){this.scripts[n.name]=n}addKeybind(n){const e=this.keybinds.findIndex(r=>r.key===n.key);e>=0&&this.keybinds.splice(e,1),this.keybinds.push(n)}}const u=new vo,Eo=o=>Object.values(o.reduce((n,e)=>(n[e.tileN]=e,n),{}));let B;const W=document.querySelector("#control_console input");let F=Ee;const bo=()=>{W?.addEventListener("keyup",o=>{const n=o.key,e=o.target.value;if(n==="Enter"&&e.length){u.history.push(e),Ve(e),o.target.value="";const r=u.getHistory();F=Math.min(r.length,Ee)}if(n==="ArrowUp"&&F>0){const r=u.getHistory();F--,W.value=r[F]??""}if(n==="ArrowDown"){const r=u.getHistory();F>=r.length?W.value="":(F++,W.value=r[F]??"")}}),W?.focus(),document.querySelector("#nav > div:first-of-type")?.addEventListener("click",o=>ut(o.target,"control_console")),document.addEventListener("keyup",o=>{if(document.activeElement===W)return;const n=u.keybinds.find(e=>e.key===o.key);n&&Ve(n.exec)})},To=()=>{let o=document.getElementById("c");o?.addEventListener("mousedown",n=>{B=[n.clientX,n.clientY]}),o?.addEventListener("mousemove",n=>{if(B){u.isFollowing=void 0;let e=[n.clientX,n.clientY];const a=.6+(u.zoom+(0-lt))*.125,c=(e[0]-(B?.[0]??0))*a,l=(e[1]-(B?.[1]??0))*a;u.camera[0]=u.camera[0]-c,u.camera[1]=u.camera[1]+l,B=e}}),o?.addEventListener("mouseup",()=>B=void 0),o?.addEventListener("mouseout",()=>B=void 0),o?.addEventListener("wheel",n=>{const e=n.deltaY;u.setZoom(u.zoom+(e>0?1:-1))})},ut=(o,n)=>{Array.from(document.querySelectorAll("div#context > div")).forEach(e=>e.classList.add("hidden")),Array.from(document.querySelectorAll("#nav > div")).forEach(e=>e.classList.remove("active")),document.getElementById(n)?.classList.remove("hidden"),o.classList.add("active")},Ao=o=>{setTimeout(()=>{A("Press a key to bind..."),document.addEventListener("keyup",n=>{const e={key:n.key,exec:o};u.addKeybind(e),A(`"${o}" bound to ${e.key}`)},{once:!0})},100)},ft=document.getElementById("welcome-modal"),wo=async()=>{ft?.classList.add("hidden"),ne.music(),bo(),await rt(),setInterval(()=>{ct()},6e4)};ft?.querySelector("button")?.addEventListener("click",()=>wo());
